







Требования
к техническому заданию
на разработку ПО 

"Фитнес-менеджер" (FitMan)


Оглавление	
Оглавление	2
Введение	2
Цель проекта	2
Общие сведения	3
Функциональные сведения	4
Краткое описание функциональных процессов	4
Функциональные требования	5
1	Основной функционал системы	5
2	Роли пользователей и их функции в системе	9
3	Система управления группами	11
4	Управление помещениями и оборудованием	22
5	Онбординг (Lead Management)	31
6	Подсистема уведомлений (Notification Service)	33
7	Подсистема чата (Messaging)	35
8	Подсистема отчетности (Reporting & Analytics)	38
9	Подсистема управления пользователями (User Management)	41



Введение
Цель проекта
Создание веб-приложения уровня предприятия с мобильным клиентом, для автоматизации процессов фитнес-центра с основным функционалом:
• ведение шаблонов и индивидуальных планов тренировок;
• контроль и учёт занятий;
• управление расписанием индивидуальных и групповых занятий;
• система онбординга клиентов;
• система уведомлений о занятиях, групповых чатов;
• контроль биологических показателей, прогрессии тренировок;
• учет полученных и затраченных калорий;
• рекомендации по тренингу;
• управление персоналом (тренеры, инструкторы, менеджеры, администраторы);
• ведение табелей сотрудников;
• ведение отчетности по клиентам, сотрудникам, занятиям, центру.

Общие сведения
ПараметрЗначениеНаименованиеФитнес-менеджер (FitMan)ТипКорпоративное приложениеЦелевая аудиторияФитнес-центры малого и среднего бизнесаПлатформыiOS, Android, WebТехнологический стекFlutter (Client) + Dart Frog/Shelf (Server) + PostgreSQLРазмещениеVPS без контейнеризации и baas


Функциональные сведения
ПараметрЗначениеТип системыОтраслевое решение для автоматизации фитнес-центровУправление бизнес-процессами   - Учет рабочего времени персонала
   - Управление расписанием и ресурсами
   - Учет занятий клиентовСпециализированный фитнес-функционал
   - Планирование и учет тренировок
   - Отслеживание прогресса клиентов
   - Учет полученных и затраченных калорий
   - Рекомендательная подсистема
Аналитика и отчетность
   - Бизнес-аналитика для руководства
   - Отчеты по эффективности тренеров
   - Анализ клиентской базы

Краткое описание функциональных процессов
Клиенты занимаются в фитнес-центре, согласно расписанию тренировок, под руководством назначенного тренера и инструктора. 
Тренер составляет групповые и индивидуальные планы тренировок. Он проводит индивидуальные занятия, может задавать прогресс нагрузок на основе плана тренировок. Тренер осуществляет общее руководство занятиями прикрепленных клиентов.
Инструктор в основном проводит групповые занятия. Так же может помочь тренеру провести индивидуальное занятие, вести учет времени. Если он имеет права, может создавать планы тренировок, задавать прогресс и т.п., аналогично функционалу тренера. 
У тренеров и инструкторов есть табель учета занятий, который составляется по факту проведения занятий.
Менеджер (куратор) осуществляет контроль за бизнес-процессами центра. Контролирует ведение журналов прикрепленных клиентов, инструкторов, тренеров. Также совместно с тренером ведет расписание тренировок. Назначенный дежурный менеджер ведет онбординг клиентов.
Администратору доступны все функции менеджера, также управляет системным функционалом, осуществляет контроль за системой.



Функциональные требования
1 Основной функционал системы 
1.1 Планирование и учет занятий с учётом инфраструктуры
Составление расписания занятий происходит с учетом:
• Пожеланий клиентов по дням недели и времени
• Доступности и загрузки залов (помещений)
• Наличия необходимого оборудования
• Расписания тренеров и инструкторов
Клиент в своём дашборде указывает предпочтительные дни и время занятий. При автоматическом составлении общего расписания система учитывает эти предпочтения, а также проверяет доступность залов и оборудования. Возможен вариант ручного обновления расписания для отдельного клиента с учётом текущей загрузки инфраструктуры.

1.2 Учет и анализ полученных и затраченных калорий
План тренировок состоит из тренировочных дней или занятий. Занятие включает набор упражнений с указанием повторов или времени выполнения.
Каждое упражнение имеет средний расход калорий. Система автоматически суммирует расход по упражнениям для занятия и по занятиям для плана тренировок.
Перед занятием клиент вносит количество потребленных калорий и свой текущий вес. После тренировки система автоматически рассчитывает затраченные калории, учитывая:
• Основной обмен веществ (BMR)
• Калории, потраченные непосредственно на занятии
• Оборудование, использованное на занятии
Клиент может сравнивать приход и расход калорий в таблице, а также просматривать графики зависимости калорий и веса от времени.

1.3 Система рекомендаций по плану тренировок на основе антропометрии, соматотипов, биоимпеданса
Система реализует двухуровневую гибридную модель рекомендаций:
1. Core-ядро (автономное, оффлайн) — алгоритмическая система, работающая на основе данных БД и детерминированных правил. Обеспечивает базовые, безопасные рекомендации, всегда доступные независимо от подключения к внешним сервисам.
2. AI Enhancer (опциональный модуль) — внешний AI-сервис (DeepSeek, Yandex GPT и др.), который при наличии доступа обогащает рекомендации ядра персонализированными советами. Модуль реализован как отдельный опциональный компонент.

1.4 Разделение форматов тренировок
Система поддерживает два принципиально разных формата занятий, каждый со своей логикой:
1. Индивидуальные занятия. Формат: 1 клиент + 1 тренер. Гибкое планирование (пакеты занятий или регулярные встречи)
2. Тренировочные группы. Формат: Множество клиентов + 1-2 тренера. Планирование: Фиксированное расписание.

• Универсальный учет занятий. Содержит общую таблицу для фиксации всех проведенных занятий любого формата, ссылается либо на индивидуальное занятие, либо на тренировочную группу
1.5 Индивидуальные планы тренировок на основе шаблонов
Система реализует модель разделения на Шаблоны и Индивидуальные назначения тренировок клиента. Такая архитектура позволяет тренеру гибко настраивать прогрессию нагрузок для каждого клиента, изменяя параметры в таблицах назначений, без изменения исходных шаблонов.

1.6 Управление пользователями через роли
Роль представляет собой набор прав доступа и полномочий, позволяющих пользователю выполнять определенные действия в системе. Такой подход упрощает администрирование, обеспечивает единообразие и безопасность, так как позволяет назначать права группам пользователей, а не каждому отдельно.
В системе реализованы следующие роли: клиент, инструктор, тренер, менеджер, администратор.
Пользователь может иметь несколько ролей, что легко и гибко расширяет набор прав доступа. Например, для небольших фитнес-залов, где тренер является единственной штатной единицей, можно добавить ему роли менеджера и администратора. Или, как вариант, роли инструктора и менеджера отключить вообще.
1.7 Двухуровневая система группирования клиентов
1.6.1	Тренировочные группы (TrainingGroup)
Для организации групповых занятий с фиксированным составом:
• Имеют привязку к основному тренеру и инструктору
• Используют конкретные залы и оборудование
• Имеют фиксированное расписание занятий
• Автоматически создают групповые чаты
Нет автоматического обновления состава (только ручное управление)
1.6.2 Аналитические группы (AnalyticGroup)
Для сегментации клиентов по различным критериям:
• Финансовые: по статусу оплаты, типу абонемента
• Демографические: по возрасту, полу
• Поведенческие: по активности, посещаемости
• Корпоративные: клиенты компаний-партнёров
• Произвольные: ручное создание
Могут быть автоматическими — состав обновляется по заданным условиям без ручного вмешательства.
1.8 Управление инфраструктурой фитнес-центра
1.7.1 Помещения и залы
• Учёт всех помещений фитнес-центра с характеристиками (вместимость, площадь, оснащение)
• Контроль доступности и загрузки залов
• Управление расписанием работы помещений
• Отслеживание технического состояния
1.7.2 Оборудование
• Типы оборудования: справочник с характеристиками (кардио, силовое, свободные веса и т.д.)
• Экземпляры оборудования: учёт конкретных единиц с инвентарными номерами
• Контроль состояния и доступности
• Бронирование оборудования для занятий
• Упрощённый учёт технического обслуживания
1.7.3 Интеграция с тренировочным процессом
• Автоматическая проверка доступности залов и оборудования при планировании занятий
• Резервирование инфраструктуры для тренировочных групп
• Учёт использования оборудования в статистике
1.9 Онбординг (привлечение и активация клиентов)
Процесс превращения потенциального клиента в активного пользователя:
1. Управление лидами (заявками через сайт или телефон)
2. Активация учётной записи через пригласительные ссылки
3. Первоначальное знакомство с инфраструктурой: ознакомление с доступными залами и оборудованием
1.10 Комплексная отчетность и аналитика
• Отчетность по клиентам: динамика базы, посещаемость, прогресс
• Отчетность по сотрудникам: загрузка тренеров, эффективность
• Отчетность по инфраструктуре: загрузка залов, использование оборудования
• Финансовая отчетность (при интеграции с финансовыми системами)
• Экспорт отчетов в PDF, Excel форматы
1.11 Оффлайн-режим и синхронизация
• Оффлайн-работа для критически важных функций (фиксация занятий, ввод данных)
• Автоматическая синхронизация при восстановлении соединения
• Кэширование расписания и данных об инфраструктуре для работы без сети

1.12 Система безопасности и контроля доступа
• Ролевая модель доступа (RBAC)
• Row Level Security в базе данных
• Аудит всех действий пользователей
• Защита персональных данных клиентов
1.13 Мультиплатформенность и адаптивность
• Мобильные приложения для iOS и Android
• Веб-версия для администрации и клиентов
• Адаптивные интерфейсы для разных устройств
• Единая база данных для всех платформ
1.14 Универсальность развёртывания и инфраструктурная независимость
Система разработана с учетом требований малого и среднего бизнеса фитнес-индустрии и обладает максимальной гибкостью в развёртывании:
• Независимость от инфраструктуры: Система может работать на любом стандартном оборудовании без специфических требований к виртуализации или контейнеризации.
• Прямое развёртывание: Установка производится напрямую на операционную систему без промежуточных слоев абстракции.
• Полный контроль данных: Все данные остаются на стороне заказчика, без зависимостей от внешних BaaS-провайдеров.


2 Подсистема управления пользователями (User Management)
Подсистема управления пользователями является фундаментом всей системы, обеспечивая безопасную аутентификацию, гибкую авторизацию на основе ролей и централизованное управление учетными записями.
2.1 Роли пользователей и их функции в системе
2.1.1 Клиент
Пользователь системы, занимающийся в фитнес-центре под руководством тренера.
Функции:
• Аутентификация;
• Ввод антропометрии. Ввод входящих калорий и веса. Ввод предпочтений занятий. Просмотр графиков калорий и веса, просмотр расписания.

2.1.2 Инструктор
Помощник тренера. Контролирует занятия, назначенных клиентов.
Функции:
• Аутентификация;
• Просмотр списка назначенных клиентов и открытие карточки клиента из списка;
• Ввод входящих калорий и входящего веса клиента. Просмотр графиков калорий и веса клиента;
• Просмотр расписания клиента, своего расписания и табеля;
• Коррекция плана занятия дня (списка упражнений);
• Фиксация начала и окончания занятия.
• Просмотр списка назначенных тренеров и открытие карточки из списка.

2.1.3 Тренер
Тренирует клиентов. Контролирует занятия, назначенных клиентов и инструкторов. Составляет планы тренировок, назначает планы клиентам.
Функции:
• Аутентификация;
• Просмотр списка назначенных клиентов и открытие карточки клиента из списка;
• Ввод входящих калорий и входящего веса клиента. Просмотр графиков калорий и веса клиента;
• Коррекция плана занятия дня (списка упражнений);
• Фиксация начала и окончания занятия.
• Доступ к кнопке "Подобрать прогрессии" в карточке клиента;
• Выбор прогрессии тренировок;
• Смена плана тренировок до первого занятия клиента;
• Просмотр списка прикрепленных инструкторов и открытие карточки из списка.
• Просмотр расписания клиента, своего расписания и табеля, расписание и табель закрепленного инструктора;

2.1.4 Менеджер
Контролирует тренировочные бизнес-процессы. Контроль за назначенными клиентами, инструкторами, тренерами.
Функции:
• Аутентификация;
• Ведение записей клиентов, инструкторов, тренеров.
• Ведение расписаний и табелей всех участников бизнес-процесса.
• Ведение обординга клиентов.

2.1.5 Администратор
Администрирует систему.
Функции:
• Аутентификация;
• Ведение (просмотр, добавление, удаление, изменение записей) каталогов.
• Ведение записей клиентов, инструкторов, тренеров, менеджеров.
• Ведение расписания работы центра.
• Редактирование настроек системы.

Управление доступом пользователя осуществляется на основе ролей.

2.2 Модель данных и ролевая система
2.2.1 Сущность «Пользователь» (User)
Универсальная сущность, хранящая общие данные для всех участников системы.
• Базовые поля:
o id (BIGSERIAL, Primary Key)
o login (String, Unique) // Логин для входа (может совпадать с email/телефоном)
o password_hash (String) // Хеш пароля (алгоритм bcrypt)
o email (String, Unique, Nullable)
o phone (String, Unique, Nullable)
o last_name (String)
o first_name (String)
o middle_name (String, Nullable)
o gender (SMALLINT) //значение перечисления в коде
o date_of_birth (DATE) //День рождения
o photo_url (String, Nullable) // Ссылка на аватар в хранилище
o created_at (Timestamp)
o updated_at (Timestamp)
o archived_at (Timestamp)
o archived_by (BIGINT FK → users(id))
o created_by (BIGINT FK → users(id))
o updated_by (BIGINT FK → users(id))

• Настройки уведомлений (хранятся в таблице user_settings):
o send_notifications (Boolean, default: true) // Разрешить уведомления
o hour_notification (Integer) // За сколько часов уведомлять о занятии
o notification_email (Boolean) // Получать на email
o notification_push (Boolean) // Получать push-уведомления
2.2.2 Ролевая модель (Role-Based Access Control - RBAC)
Гибкая система, позволяющая назначать пользователю несколько ролей.
• Таблица roles:
o id (Primary Key)
o name (String, Unique: 'client', 'instructor', 'trainer', 'manager', 'admin') // Системное имя
o title (String) // Человекочитаемое название ('Клиент', 'Тренер')
o icon (String) // Иконка роли для UI
• Таблица user_roles (связь многие-ко-многим):
o user_id (Foreign Key -> users)
o role_id (Foreign Key -> roles)
o assigned_at (Timestamp)
• Иерархия и комбинации ролей:
o Пользователь может иметь несколько ролей.
o Пример: В небольшом клубе тренер может иметь роли trainer, manager и admin.
o Наличие роли определяется бизнес-логикой, а не техническими ограничениями.
2.2.3 Профили конкретных ролей (Profile Tables)
Дополнительные данные, специфичные для роли, хранятся в отдельных таблицах с связью One-to-One к основной таблице users.
• Таблица client_profiles (для клиентов):
o user_id (Primary Key, Foreign Key -> users)
o goal_training_id (Foreign Key -> goals_training)
o level_training_id (Foreign Key -> levels_training)
o track_calories (Boolean, default: true) // Включить учет калорий
o coeff_activity (Double, default: 1.2) // Коэффициент активности

• Таблица instructor_profiles (для инструкторов):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах
o is_duty (Boolean, default: false) // Дежурный (логика на основе employees_duty)
o can_replace_trainer (Boolean, default: false) // Может замещать тренера
o can_create_plan (Boolean, default: false) // Может создавать планы тренировок

• Таблица trainer_profiles (для тренеров):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах

• Таблица manager_profiles (для менеджеров):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах
o is_duty (Boolean, default: false) // Дежурный (логика на основе employees_duty)

2.2.4 Требования к ролям в пользовательских интерфейсах

1. Пользователи с ролями "Инструктор", "Тренер", "Менеджер" могут иметь несколько ролей, кроме роли "Клиент".
2. Если роль одна, созданная при создании пользователя, то она считается основной. В дашбордах перечисленных пользователей она не отображается.
3. Если ролей несколько, то в дашборде выводится список ролей с подзаголовком: "Роли". Добавлять или удалять роли из списка может только администратор. Основную роль удалить нельзя.
4. Если у пользователя несколько ролей, то при входе предлагать выбор роли в попап-окне. Такой же функционал при входе в дашборд из списка пользователей в дашборде администратора.
5.  Пользователи с ролью "Клиент" могут иметь только одну роль при создании.

2.3 Функциональные требования
2.3.1 Жизненный цикл учетной записи
• Создание пользователя:
o Сценарий А (Администратором): Через интерфейс "Создание пользователя" с ручным назначением ролей.
o Сценарий Б (Самостоятельная регистрация): Через процесс онбординга (пригласительная ссылка).
• Активация/Деактивация: Возможность временно отключить учетную запись без удаления данных (is_active = false).
• Удаление: Строго логическое удаление. Запись помечается как удаленная (is_deleted = true), данные сохраняются для аудита.
2.3.2 Аутентификация и безопасность
• Вход в систему: По паре login (email/телефон) и password.
• Политика паролей:
o Минимальная длина: 8 символов.
o Обязательные категории: заглавные и строчные буквы, цифры, специальный символ.
o Запрет на использование простых паролей (проверка against словаря).
• Защита от брутфорса: Блокировка учетной записи после 5 неудачных попыток входа за 15 минут.
• Сброс пароля: Стандартный flow через email с одноразовой ссылкой.
• Смена пароля: Обязательна при первом входе, если пароль был установлен администратором.
2.3.3 Управление пользователями (CRUD)
• Просмотр списка пользователей:
o Интерфейс: Единый дашборд с возможностью фильтрации по ролям, активности, ФИО.
o Отображение: Аватар, ФИО, основные роли, контакты, статус активности.
• Создание/Редактирование пользователя:
o Универсальная форма: Основные поля (ФИО, контакты, логин).
o Динамические блоки: В зависимости от выбранных ролей появляются дополнительные поля (например, блок "Данные клиента" при назначении роли client).
o Назначение ролей: Выбор из списка с чекбоксами.
• Управление доступом: Только пользователи с ролями admin и manager имеют полный доступ к CRUD. Тренер может просматривать и редактировать только своих клиентов.
2.4 Техническая реализация
2.4.1 Безопасность (Row Level Security - RLS)
• Для всех таблиц (users, client_profiles, etc.) должны быть настроены политики RLS.
• Пример политики для users:
o Администратор (role_admin) видит всех пользователей.
o Менеджер (role_manager) видит пользователей, которые являются его клиентами/тренерами/инструкторами (через таблицы связей manager_client, manager_trainer, manager_instructor).
o Тренер (role_trainer) видит только себя и своих клиентов/инструкторов.
o Инструктор (role_instructor) видит только себя и своих.
o Клиент (role_client) видит только свою учетную запись.
2.4.2 Процессы и бизнес-логика
• Создание клиента из лида: При нажатии "Создать клиента" в карточке лида система:
1. Создает запись в users на основе данных из onboarding_client.
2. Назначает пользователю роль client.
3. Закрепляет клиента за менеджером-куратором  curator_manager_id.
4. Создает запись в client_profiles.

 Проверка уникальности: При создании/редактировании обязательна проверка на уникальность login, email, phone.

2.5 Требования к списочным формам, карточкам, дашбордам
• Все ListView должны быть пагинированы.
• В карточке или дашборде, в панели инструментов должна быть кнопка "Инфо", по клику которой в popup-окне выводится диагностическая информация: имя таблицы сущности, id записи таблицы. Так же выводятся поля: created_at, updated_at, created_by, updated_by. Данная кнопка доступна всем, кроме клиентов.
2.6 Требования к личной информации в дашбордах
В каждом типе дашборда пользователей должен быть экран "Профиль" с основными данными из таблицы users:
• photo (URL). //Фото.
• login (string). //Логин.
• lastName (string). //Фамилия.
• firstName (string). //Имя.
• middleName (string). //Отчество.
• fullName (string). //Полное ФИО, расчетное.
• shortName (string). //Краткое ФИО, расчетное.
• gender (string). //Пол.
• date_of_birth (DateTime). //День рождения.
• age (int). //Возраст. Расчетное.
• phone (string). //Телефон.
• email (string). //E-mail.
• sendNotification (bool). //Посылать уведомления. Поле есть у всех, кроме админа.
• hourNotification (duration). //Время уведомления до занятий (в часах).  Поле есть у всех, кроме админа.
• List<Role> roles. //Список ролей, если больше одной. Поле есть у всех, кроме клиента.
В случае дашборда клиента, отображаются дополнительные поля:
• trackCalories (bool) //Учет калорий.
• double coeffActivity = //Минимальный коэффициент активности.

Экран должен отображаться после нажатия на кнопку "Профиль" в меню дашборда.



3 Подсистема управления группами
3.1 Общие положения
3.2.1 Назначение
Тренировочные группы предназначены для организации регулярных групповых занятий с фиксированным составом участников. Они используются в расписании занятий и имеют прямые связи с персоналом, оборудованием и локациями.
3.2.2 Типы тренировочных групп
Система поддерживает три типа тренировочных групп:
1. Групповые занятия (Group) — стандартные группы (3+ человек)
2. Полуперсональные тренировки (SemiPersonal) — малые группы (2-3 человека)
3.2.3 Модель данных

enum TrainingGroupType {
  group,         // Групповые занятия (3+ человек)
  semiPersonal,  // Полуперсональные тренировки (2 человека)
}

class TrainingGroup {
  String id;
  String name;
  String description;
  
    // Тип группы
  TrainingGroupType groupType;

// ПЕРСОНАЛ (обязательные для тренировочного процесса)
  String primaryTrainerId;     // Основной тренер группы
  String? primaryInstructorId; // Основной инструктор группы
  String? responsibleManagerId; // Ответственный менеджер
  
  // СОСТАВ ГРУППЫ (фиксированный)
  List<String> clientIds;      // Фиксированный состав участников
  
  // РАСПИСАНИЕ ЗАНЯТИЙ
  List<GroupScheduleSlot> scheduleSlots;
  
  // ПАРАМЕТРЫ ТРЕНИРОВКИ
  String? programId;           // Ссылка на программу тренировок
  String? goalId;              // Цель тренировок (похудение, набор массы и т.д.)
  String? levelId;             // Уровень подготовки группы
  
  // ЛИМИТЫ И ОГРАНИЧЕНИЯ
  DateTime startDate;          // Дата начала работы группы
  DateTime? endDate;           // Дата окончания (если предусмотрена)
  int maxParticipants;         // Максимальное количество участников
  int currentParticipants;     // Текущее количество участников

  // ПОМЕЩЕНИЕ И ОБОРУДОВАНИЕ
  String? primaryRoomId;     // Основной зал для занятий
  List<String> requiredEquipmentIds; // Необходимое оборудование
  
// ТАРИФИКАЦИЯ 
  double? pricePerSession;  // Цена за занятие (особенно для semiPersonal)
  String? pricingModel;     // "per_session", "monthly", "package"

  // СТАТУС И СВЯЗИ
  bool isActive;               // Активна ли группа
  String? chatId;              // Ссылка на групповой чат (создается автоматически)
}

3.2.4 Расписание группы (GroupScheduleSlot)

class GroupScheduleSlot {
  String id;
  String groupId;
  int dayOfWeek;          // 1-7 (понедельник-воскресенье)
  TimeOfDay startTime;
  TimeOfDay endTime;
  bool isActive;
}

3.2.5 Правила тренировочных групп

• Фиксированный состав - состав участников изменяется только вручную тренером или менеджером
• Обязательный тренер - каждая группа должна иметь основного тренера
• Четкое расписание - группа имеет расписание занятий на неделю
• Прямое участие в расписании - группа используется при создании занятий в модуле расписания
• Автоматический чат - при создании группы автоматически создается групповой чат

3.2.5.1 Правила для полных  групп
1. Количество участников:
o 3+ человека
o При попытке убавить до 2 участников — предупреждение о смене типа на полуперсональную группу.
2. Расписание:
o Возможность переноса занятий с уведомлением всех участников
3. Тарификация:
o Отдельный прайс-лист для тренировок
o Возможность разных схем оплаты:
• За занятие
• Абонемент на 4/8/12 занятий
• Ежемесячная подписка
4. Автоматизация:
o При попытке убавить до 2 участников — предложение преобразовать в полуперсональную группу.

3.2.5.2 Правила для полуперсональных групп
5. Количество участников:
o 2 человека
o При попытке добавить 3-го участника — предупреждение о смене типа на "Групповое занятие"
6. Расписание:
o Более гибкое, чем у групповых занятий
o Возможность переноса занятий с уведомлением всех участников
7. Тарификация:
o Отдельный прайс-лист для полуперсональных тренировок
o Возможность разных схем оплаты:
• За занятие
• Абонемент на 4/8/12 занятий
• Ежемесячная подписка
8. Автоматизация:
o При уменьшении группы до 1 человека — предложение преобразовать в индивидуальную группу.
o При увеличении до 3+ человек — предложение преобразовать в полную группу.

3.2.6 Бизнес-процессы

• Создание группы: Тренер или менеджер создает группу, назначает тренера, настраивает расписание
• Набор участников: Ручное добавление клиентов в группу с проверкой лимита
• Проведение занятий: Занятия создаются на основе расписания группы
• Закрытие группы: При достижении endDate менеджеру группы посылается уведомление для ручного закрытия группы.
   3.4 Структура таблиц
3.4.1 Таблица тренировочных групп

CREATE TABLE training_groups (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  
  -- Персонал
  primary_trainer_id BIGINT NOT NULL REFERENCES users(id),
  primary_instructor_id BIGINT REFERENCES users(id),
  responsible_manager_id BIGINT REFERENCES users(id),
  
  -- Программа тренировок
  program_id BIGINT REFERENCES training_plan_templates(id),
  goal_id BIGINT REFERENCES goals_training(id),
  level_id BIGINT REFERENCES levels_training(id),
  
  -- Лимиты
  max_participants INT NOT NULL DEFAULT 15,
  current_participants INT DEFAULT 0,
  
  -- Жизненный цикл
  start_date DATE NOT NULL,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  
  -- Связи
  chat_id BIGINT REFERENCES chats(id),
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id)
);

3.4.2 Таблица расписания групп

CREATE TABLE group_schedule_slots (
  id BIGSERIAL PRIMARY KEY,
  group_id BIGINT NOT NULL REFERENCES training_groups(id),
  day_of_week SMALLINT NOT NULL, -- 1-7
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  is_active BOOLEAN DEFAULT true
);

3.4.3 Таблица участников тренировочных групп 
CREATE TABLE training_group_members (
  id BIGSERIAL PRIMARY KEY,
  training_group_id BIGINT NOT NULL REFERENCES training_groups(id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL REFERENCES users(id),
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  added_by BIGINT REFERENCES users(id),
  UNIQUE(training_group_id, user_id)
);

3.4.5 Типы тренировочных групп
CREATE TABLE training_group_types (
  id SMALLSERIAL PRIMARY KEY,
  name VARCHAR(50) NOT NULL,          -- 'group', 'semi_personal', 'individual'
  title VARCHAR(100) NOT NULL,        -- 'Групповое занятие', 'Полуперсональная тренировка', 'Индивидуальное занятие'
  min_participants INT NOT NULL DEFAULT 1,
  max_participants INT NOT NULL DEFAULT 1,
  description TEXT,
  icon VARCHAR(50),                   -- Иконка для UI
  color VARCHAR(7)                    -- Цвет для UI (#RRGGBB)
);


   3.5 Архитектура и расположение кода
3.5.1 Бэкенд

    1 /backend/lib/modules/groups/
    2 ├── controllers/
    3 │   ├── training_group_controller.dart    # API для тренировочных групп (CRUD, участники)
    4 │   └── analytic_group_controller.dart    # API для аналитических групп
    5 │
    6 ├── models/
    7 │   ├── training_group.model.dart         # Модель тренировочной группы
    8 │   ├── analytic_group.model.dart         # Модель аналитической группы
    9 │   └── group_schedule.model.dart         # Модель расписания (используется в обеих типах групп)
   10 │
   11 ├── repositories/
   12 │   └── group_repository.dart             # ЕДИНЫЙ репозиторий для всех таблиц, связанных с группами.
   13 │                                         # Это упростит работу с транзакциями и сложными запросами.
   14 │
   15 └── services/
   16     └── group_service.dart                # ЕДИНЫЙ сервис для всей бизнес-логики. Управляет
   17                                           # репозиторием и координирует операции над всеми типами групп.

3.5.2 Фронтенд

    1 /frontend/lib/modules/groups/
    2 ├── models/
    3 │   ├── training_group.model.dart         # Модель тренировочной группы
    4 │   ├── analytic_group.model.dart         # Модель аналитической группы
    5 │   ├── group_schedule.model.dart         # Модель расписания
    6 │   ├── group_condition.model.dart        # Модель условия для аналитических групп
    7 │   └── training_group_type.model.dart    # Модель типа тренировочной группы
    8 │
    9 ├── providers/
   10 │   └── group_providers.dart                # Единый файл для всех провайдеров, связанных с группами
   11 │
   12 ├── screens/
   13 │   ├── training/                           # --- Экраны для ТРЕНИРОВОЧНЫХ групп ---
   14 │   │   ├── training_groups_screen.dart     # Экран со списком тренировочных групп
   15 │   │   └── training_group_edit_screen.dart   # Экран создания/редактирования тренировочной группы
   16 │   │
   17 │   └── analytic/                           # --- Экраны для АНАЛИТИЧЕСКИХ групп ---
   18 │       ├── analytic_groups_screen.dart     # Экран со списком аналитических групп
   19 │       └── analytic_group_edit_screen.dart   # Экран создания/редактирования аналитической группы
   20 │
   21 ├── services/
   22 │   └── group_service.dart                  # Единый клиентский сервис для работы с API групп
   23 │
   24 └── widgets/
   25     ├── training/                           # Виджеты, специфичные для тренировочных групп
   26     │   └── training_group_card.dart        # Карточка для отображения тренировочной группы в списке
   27     │
   28     ├── analytic/                           # Виджеты, специфичные для аналитических групп
   29     │   └── analytic_group_card.dart        # Карточка для отображения аналитической группы в списке
   30     │
   31     └── common/                             # Общие виджеты, используемые в обеих секциях
   32         └── group_member_list.dart          # Виджет для отображения и редактирования списка участников
   3.6 Интеграция с другими модулями
3.6.1 С модулем расписания

    Тренировочные группы используются при создании групповых занятий
    Автоматическая подстановка тренера, инструктора и состава группы
    Проверка доступности зала и оборудования

3.6.2 С модулем чата

    При создании тренировочной группы автоматически создается групповой чат
    Участники чата: клиенты группы, тренер, инструктор, менеджер

3.6.3 С модулем отчетности

    Отчеты по эффективности тренировочных групп
    Аналитика по сегментам клиентов (аналитические группы)
    Отслеживание динамики состава групп

3.6.4 С модулем уведомлений

    Уведомления о расписании групповых занятий
    Массовые рассылки для аналитических групп
    Напоминания о необходимости продления участия в группе

   3.7 Пользовательские интерфейсы
3.7.1 Дашборд тернировочных групп

    Состоит из списка групп с возможностью просмотра состава и расписания

3.7.2 Форма создания/редактирования тренировочной группы

• Основные параметры (название, описание)
• Выбор тренера, инструктора, менеджера
• Настройка расписания (дни недели, время)
• Установка лимитов и сроков
• Выбор типа группы (радиокнопки):
o Групповое занятие (от 3 человек)
o Полуперсональная тренировка (2 человека)
• Автоматическая валидация:
o При выборе "Полуперсональная" — maxParticipants автоматически устанавливается в 2
o При попытке изменить maxParticipants вне диапазона 3 — предупреждение
o Максимальное количество участников не может быть меньше текущего
o Дата окончания не может быть раньше даты начала
• Блок тарификации (появляется только для полуперсональных):
o Поле "Цена за занятие"
o Выбор модели оплаты
o Настройка скидок при покупке пакета
4 Управление инфраструктурой: Здания и Помещения
4.1 Общие положения
Модуль управления инфраструктурой обеспечивает полный учёт всех физических активов фитнес-центра, разделяя их на два уровня иерархии: **Здания** и **Помещения**. Эта структура позволяет гибко управлять как крупными объектами (корпусами), так и отдельными залами, кабинетами и зонами внутри них.
• **Здания (Buildings):** Верхнеуровневая сущность, представляющая собой отдельный корпус или строение.
• **Помещения (Rooms):** Сущность, описывающая конкретный зал, студию или зону, которая всегда принадлежит определенному зданию.

4.2 Модель данных
4.2.1 Сущность «Здание» (Building)
Хранит основную информацию о корпусах фитнес-центра.
• **Модель данных:**
  ```dart
  class Building {
    String id;
    String name;      // Название, e.g., "Главный корпус"
    String address;   // Адрес
    String? note;     // Примечание
    DateTime? archivedAt; // Дата архивации
  }
  ```
• **Таблица `buildings` в БД:**
  ```sql
  CREATE TABLE buildings (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    note TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    archived_at TIMESTAMPTZ
  );
  ```

4.2.2 Сущность «Помещение» (Room)
Описывает характеристики конкретного помещения и его принадлежность к зданию.
• **Модель данных (ключевые изменения):**
  ```dart
  class Room {
    String id;
    String name;              // "Зал групповых программ", "Кардио-зона"
    String buildingId;        // Ссылка на здание (обязательно)
    String? buildingName;     // Денормализованное имя здания для удобства отображения
    RoomType type;            // Тип помещения (enum)
    int? floor;               // Этаж (число, не строка)
    int maxCapacity;          // Максимальная вместимость (чел.)
    double? area;             // Площадь (м²)
    bool isActive;            // Статус активности
    DateTime? archivedAt;     // Дата архивации
    String? archivedReason;   // Причина архивации
    DateTime? deactivateAt;   // Дата деактивации (используется для архивации)
    String? deactivateReason; // Причина деактивации (используется для архивации)
    List<String> photoUrls;   // Фотографии
  }
  ```
• **Таблица `rooms` в БД (ключевые изменения):**
  ```sql
  CREATE TABLE rooms (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    building_id BIGINT NOT NULL REFERENCES buildings(id), -- Связь со зданием
    type SMALLINT NOT NULL,
    floor INT, -- Изменен тип на INTEGER
    max_capacity INT NOT NULL DEFAULT 10,
    area DECIMAL(5,2),
    is_active BOOLEAN DEFAULT true,
    photo_urls JSONB,
    -- ... системные поля ...
    archived_at TIMESTAMPTZ,
    archived_reason TEXT, -- Новое поле
    deactivate_at TIMESTAMPTZ,
    deactivate_reason TEXT
  );
  ```

4.3 Пользовательские интерфейсы (UI/UX)
Управление инфраструктурой осуществляется через раздел "Инфраструктура" в дашбордах сотрудников.
4.3.1 Управление Зданиями
Интерфейсы для CRUD-операций над сущностью "Здание".
• **Список зданий (`buildings_list_screen.dart`):**
  - Простой табличный вид с колонками: "Название", "Адрес".
  - Панель действий с кнопкой "Создать здание".
  - При клике на строку открывается карточка с деталями.
• **Форма создания/редактирования Здания (`building_create_screen.dart`, `building_edit_screen.dart`):**
  - Поля: "Название*", "Адрес*", "Примечание".
  - Поля, отмеченные `*`, обязательны для заполнения.

4.3.2 Управление Помещениями
• **Дашборд инфраструктуры (`infrastructure_dashboard_screen.dart`):**
  - Отображает KPI по помещениям.
  - Визуальная карта залов с цветовой индикацией статуса.
  - Кнопки-фильтры для быстрого переключения между "Активными" и "Архивированными" помещениями.
• **Список помещений (`rooms_list_screen.dart`):**
  - **Вид:** Одноколоночный вертикальный список `ListView.builder`.
  - **Элемент списка:** Карточка `ListTile` со следующей структурой:
    - `leading`: Иконка, соответствующая типу помещения (`room.type.icon`).
    - `title`: Название помещения.
    - `subtitle`: Краткая информация:
      - Тип: [Тип помещения]
      - Статус: [Активно/Неактивно] (в виде цветного чипа)
      - Архивный статус (если применимо).
    - **Убраны поля:** Здание, Этаж, Номер, Площадь, Вместимость для более компактного вида.
  - **Панель инструментов:**
    - Поиск по названию или номеру.
    - Меню действий: "Добавить", "Изменить", "Архивировать", "Деархивировать".
    - Фильтры: по типу помещения, по статусу (активные/неактивные), по архивному статусу.
• **Форма создания/редактирования Помещения (`room_create_screen.dart`, `room_edit_screen.dart`):**
  - **Порядок полей:** Сгруппированы по логике для удобства пользователя.
  - **Выбор здания:** Обязательное поле (выпадающий список).
    - **Автовыбор:** Если в системе есть только одно активное здание, оно выбирается автоматически.
  - **Валидация:**
    - Поля "Название", "Здание", "Тип", "Вместимость" обязательны к заполнению (помечены `*`).
    - "Вместимость" должна быть больше 0.
    - "Этаж" является числовым полем.
• **Карточка деталей Помещения (`room_detail_screen.dart`):**
  - **Группировка:** Информация о статусе (активность, причина деактивации/архивации) вынесена в отдельный блок для наглядности.
  - Поля расположены в том же логическом порядке, что и в форме редактирования.

4.4 Бизнес-логика и процессы
• **Архивация Помещения:**
  - При выборе действия "Архивировать" появляется диалоговое окно.
  - Пользователь обязан указать причину архивации (не менее 5 символов).
  - После подтверждения у помещения устанавливается `isActive = false`, `archivedAt` = текущая дата, и сохраняется `archivedReason`.
• **Деархивация:** Сбрасывает флаги и даты, связанные с архивацией, устанавливает `isActive = true`.
• **Связь Помещения и Здания:** Помещение не может существовать без привязки к зданию. При удалении здания все связанные с ним помещения также должны быть обработаны (например, архивированы).

4.5 Архитектура и расположение кода
4.5.1 Бэкенд (`/backend/lib/modules/infrastructure/`)
Структура модуля была расширена для поддержки новых сущностей.
```
/infrastructure/
├── controllers/
│   ├── building_controller.dart  # (Новый) API для зданий
│   └── room_controller.dart      # Обновлен для работы с фильтрами
├── models/
│   ├── building/
│   │   └── building.model.dart   # (Новый) Модель здания
│   └── room/
│       └── room.model.dart       # Обновленная модель помещения
├── repositories/
│   ├── building_repository.dart  # (Новый) Репозиторий для зданий
│   └── room_repository.dart      # Обновлен (запросы с JOIN, фильтры)
└── services/
    ├── building_service.dart     # (Новый) Сервис для зданий
    └── room_service.dart         # Обновлен
```
4.5.2 Фронтенд (`/frontend/lib/modules/infrastructure/`)
Аналогично расширена структура для поддержки полного цикла CRUD для зданий и обновленного интерфейса для помещений.
```
/infrastructure/
├── models/
│   ├── building/                 # (Новый) Модели для зданий
│   │   └── building.model.dart
│   └── room/
│       └── room.model.dart       # Обновленная модель помещения
├── providers/
│   ├── building_provider.dart    # (Новый) Провайдеры для зданий
│   └── room_provider.dart        # Обновлен (логика фильтрации)
├── screens/
│   ├── building/                 # (Новый) Экраны для управления зданиями
│   │   ├── buildings_list_screen.dart
│   │   ├── building_create_screen.dart
│   │   └── ...
│   └── room/                     # Экраны для управления помещениями
│       ├── rooms_list_screen.dart  # Переписан на ListView, убраны поля
│       ├── room_create_screen.dart # Обновлен (порядок, валидация, автовыбор)
│       └── ...
└── widgets/
    └── room/
        └── room_card.dart        # (Удален) Специализированный виджет-карточка был создан, но впоследствии его логика была возвращена в ListTile в rooms_list_screen для упрощения.
```


5 Расписание занятий
5.1 Виды и шаблоны расписаний
   Система должна поддерживать следующие виды расписаний и их отображение:
5.1.1 Общее расписание зала
Сводная таблица всех групповых занятий на неделю с привязкой ко времени, залу и тренеру. Должна поддерживать фильтрацию по залу и типу занятия.
5.1.2 Персональное расписание тренера и инструктора
Детальное расписание конкретного тренера с указанием клиентов, планов тренировок и статусов занятий на каждый день. Должно отображать свободные и занятые слоты.
5.1.3 Индивидуальное расписание клиента
Упрощенный вид, отображающий только занятия конкретного клиента с указанием статуса (Завершено, Запланировано, Отменено, Заморожено).
5.1.4 Коллизии предпочтений клиентов
При коллизии (см. класс ClientPreferenceSchedule), отдавать приоритет по дате-времени регистрации. 
5.1.5 Поддержка сложных сценариев
o Повторяющиеся события: Создание расписания по шаблону (ежедневно, еженедельно) на указанный период.
o Исключения: Возможность отменить одно повторяющееся событие в серии.
o Перенос: Возможность изменить время или дату одного события в серии.
o Контроль конфликтов: Система не должна позволять назначать клиенту или тренеру два занятия на одно и то же время.

5.2 Процесс составления расписания
1. Выбор плана тренировок.
2. Проверка конфликтов.
3. Генерация расписания на период.
4. UI для составления расписания.
5. Интеграция с каталогами.
5.3 Процесс работы:
1. Менеджер/Тренер выбирает дату, время, тренера.
2. Система предлагает подходящие планы тренировок based on цели клиентов.
3. Проверяются конфликты в расписании.
4. Рассчитывается длительность и калорийность.
5. Создается расписание с привязкой ко всем каталогам.
5.4 Таблицы расписания
1. Основная таблица расписания schedules.
2. Таблица связи расписания с клиентами schedule_clients.
3. Таблица повторяющихся расписаний recurring_schedules.
4. Таблица исключений расписания schedule_exceptions.
5. Таблица уведомлений о занятиях schedule_notifications.
6. Выходная таблица занятий lessons.
6 Архитектура планов тренировок
Система должна реализовывать модель разделения на Шаблоны и Индивидуальные назначения для поддержки кастомизации тренировок для каждого клиента.
6.1 Таблицы шаблонов (Templates)
Являются общей библиотекой сущностей, доступной для создания и редактирования тренерам.
o training_plan_templates
o set_exercise_templates
o exercise_templates
6.2 Таблицы индивидуальных назначений (Assignments)
Связывают клиента с его персональной версией плана тренировок, созданной на основе шаблонов. Поля в этих таблицах позволяют переопределить любые параметры шаблона (повторы, длительность, порядок, заметки).
o client_training_plans - Связь "клиент - план". Хранит активный план и историю назначений.
o client_set_exercises - Индивидуальные наборы упражнений в рамках плана клиента.
o client_exercises - Индивидуальные упражнения в рамках набора клиента.
6.3 Связь с занятиями
Таблица lessons должна быть связана с таблицей client_training_plans через foreign key, чтобы однозначно идентифицировать, какая персональная версия плана отрабатывалась на занятии.



1


