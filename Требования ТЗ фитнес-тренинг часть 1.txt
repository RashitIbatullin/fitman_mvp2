







Требования
к техническому заданию
на разработку ПО 

"Фитнес-менеджер" (FitMan)


Оглавление	
Оглавление	2
Введение	2
Цель проекта	2
Общие сведения	3
Функциональные сведения	4
Краткое описание функциональных процессов	4
Функциональные требования	5
1	Основной функционал системы	5
2	Роли пользователей и их функции в системе	9
3	Система управления группами	11
4	Управление помещениями и оборудованием	22
5	Онбординг (Lead Management)	31
6	Подсистема уведомлений (Notification Service)	33
7	Подсистема чата (Messaging)	35
8	Подсистема отчетности (Reporting & Analytics)	38
9	Подсистема управления пользователями (User Management)	41



Введение
Цель проекта
Создание веб-приложения уровня предприятия с мобильным клиентом, для автоматизации процессов фитнес-центра с основным функционалом:
• ведение шаблонов и индивидуальных планов тренировок;
• контроль и учёт занятий;
• управление расписанием индивидуальных и групповых занятий;
• система онбординга клиентов;
• система уведомлений о занятиях, групповых чатов;
• контроль биологических показателей, прогрессии тренировок;
• учет полученных и затраченных калорий;
• рекомендации по тренингу;
• управление персоналом (тренеры, инструкторы, менеджеры, администраторы);
• ведение табелей сотрудников;
• ведение отчетности по клиентам, сотрудникам, занятиям, центру.

Общие сведения
ПараметрЗначениеНаименованиеФитнес-менеджер (FitMan)ТипКорпоративное приложениеЦелевая аудиторияФитнес-центры малого и среднего бизнесаПлатформыiOS, Android, WebТехнологический стекFlutter (Client) + Dart Frog/Shelf (Server) + PostgreSQLРазмещениеVPS без контейнеризации и baas


Функциональные сведения
ПараметрЗначениеТип системыОтраслевое решение для автоматизации фитнес-центровУправление бизнес-процессами   - Учет рабочего времени персонала
   - Управление расписанием и ресурсами
   - Учет занятий клиентовСпециализированный фитнес-функционал
   - Планирование и учет тренировок
   - Отслеживание прогресса клиентов
   - Учет полученных и затраченных калорий
   - Рекомендательная подсистема
Аналитика и отчетность
   - Бизнес-аналитика для руководства
   - Отчеты по эффективности тренеров
   - Анализ клиентской базы

Краткое описание функциональных процессов
Клиенты занимаются в фитнес-центре, согласно расписанию тренировок, под руководством назначенного тренера и инструктора. 
Тренер составляет групповые и индивидуальные планы тренировок. Он проводит индивидуальные занятия, может задавать прогресс нагрузок на основе плана тренировок. Тренер осуществляет общее руководство занятиями прикрепленных клиентов.
Инструктор в основном проводит групповые занятия. Так же может помочь тренеру провести индивидуальное занятие, вести учет времени. Если он имеет права, может создавать планы тренировок, задавать прогресс и т.п., аналогично функционалу тренера. 
У тренеров и инструкторов есть табель учета занятий, который составляется по факту проведения занятий.
Менеджер (куратор) осуществляет контроль за бизнес-процессами центра. Контролирует ведение журналов прикрепленных клиентов, инструкторов, тренеров. Также совместно с тренером ведет расписание тренировок. Назначенный дежурный менеджер ведет онбординг клиентов.
Администратору доступны все функции менеджера, также управляет системным функционалом, осуществляет контроль за системой.



Функциональные требования
1 Основной функционал системы 
1.1 Планирование и учет занятий с учётом инфраструктуры
Составление расписания занятий происходит с учетом:
• Пожеланий клиентов по дням недели и времени
• Доступности и загрузки залов (помещений)
• Наличия необходимого оборудования
• Расписания тренеров и инструкторов
Клиент в своём дашборде указывает предпочтительные дни и время занятий. При автоматическом составлении общего расписания система учитывает эти предпочтения, а также проверяет доступность залов и оборудования. Возможен вариант ручного обновления расписания для отдельного клиента с учётом текущей загрузки инфраструктуры.

1.2 Учет и анализ полученных и затраченных калорий
План тренировок состоит из тренировочных дней или занятий. Занятие включает набор упражнений с указанием повторов или времени выполнения.
Каждое упражнение имеет средний расход калорий. Система автоматически суммирует расход по упражнениям для занятия и по занятиям для плана тренировок.
Перед занятием клиент вносит количество потребленных калорий и свой текущий вес. После тренировки система автоматически рассчитывает затраченные калории, учитывая:
• Основной обмен веществ (BMR)
• Калории, потраченные непосредственно на занятии
• Оборудование, использованное на занятии
Клиент может сравнивать приход и расход калорий в таблице, а также просматривать графики зависимости калорий и веса от времени.

1.3 Система рекомендаций по плану тренировок на основе антропометрии, соматотипов, биоимпеданса
Система реализует двухуровневую гибридную модель рекомендаций:
1. Core-ядро (автономное, оффлайн) — алгоритмическая система, работающая на основе данных БД и детерминированных правил. Обеспечивает базовые, безопасные рекомендации, всегда доступные независимо от подключения к внешним сервисам.
2. AI Enhancer (опциональный модуль) — внешний AI-сервис (DeepSeek, Yandex GPT и др.), который при наличии доступа обогащает рекомендации ядра персонализированными советами. Модуль реализован как отдельный опциональный компонент.

1.4 Индивидуальные планы тренировок на основе шаблонов
Система реализует модель разделения на Шаблоны и Индивидуальные назначения тренировок клиента. Такая архитектура позволяет тренеру гибко настраивать прогрессию нагрузок для каждого клиента, изменяя параметры в таблицах назначений, без изменения исходных шаблонов.

1.5 Управление пользователями через роли
Роль представляет собой набор прав доступа и полномочий, позволяющих пользователю выполнять определенные действия в системе. Такой подход упрощает администрирование, обеспечивает единообразие и безопасность, так как позволяет назначать права группам пользователей, а не каждому отдельно.
В системе реализованы следующие роли: клиент, инструктор, тренер, менеджер, администратор.
Пользователь может иметь несколько ролей, что легко и гибко расширяет набор прав доступа. Например, для небольших фитнес-залов, где тренер является единственной штатной единицей, можно добавить ему роли менеджера и администратора. Или, как вариант, роли инструктора и менеджера отключить вообще.
1.6 Двухуровневая система группирования клиентов
1.6.1	Тренировочные группы (TrainingGroup)
Для организации групповых занятий с фиксированным составом:
• Имеют привязку к основному тренеру и инструктору
• Используют конкретные залы и оборудование
• Имеют фиксированное расписание занятий
• Автоматически создают групповые чаты
Нет автоматического обновления состава (только ручное управление)
1.6.2 Аналитические группы (AnalyticGroup)
Для сегментации клиентов по различным критериям:
• Финансовые: по статусу оплаты, типу абонемента
• Демографические: по возрасту, полу
• Поведенческие: по активности, посещаемости
• Корпоративные: клиенты компаний-партнёров
• Произвольные: ручное создание
Могут быть автоматическими — состав обновляется по заданным условиям без ручного вмешательства.
1.7 Управление инфраструктурой фитнес-центра
1.7.1 Помещения и залы
• Учёт всех помещений фитнес-центра с характеристиками (вместимость, площадь, оснащение)
• Контроль доступности и загрузки залов
• Управление расписанием работы помещений
• Отслеживание технического состояния
1.7.2 Оборудование
• Типы оборудования: справочник с характеристиками (кардио, силовое, свободные веса и т.д.)
• Экземпляры оборудования: учёт конкретных единиц с инвентарными номерами
• Контроль состояния и доступности
• Бронирование оборудования для занятий
• Упрощённый учёт технического обслуживания
1.7.3 Интеграция с тренировочным процессом
• Автоматическая проверка доступности залов и оборудования при планировании занятий
• Резервирование инфраструктуры для тренировочных групп
• Учёт использования оборудования в статистике
1.8 Онбординг (привлечение и активация клиентов)
Процесс превращения потенциального клиента в активного пользователя:
1. Управление лидами (заявками через сайт или телефон)
2. Активация учётной записи через пригласительные ссылки
3. Первоначальное знакомство с инфраструктурой: ознакомление с доступными залами и оборудованием
1.9 Комплексная отчетность и аналитика
• Отчетность по клиентам: динамика базы, посещаемость, прогресс
• Отчетность по сотрудникам: загрузка тренеров, эффективность
• Отчетность по инфраструктуре: загрузка залов, использование оборудования
• Финансовая отчетность (при интеграции с финансовыми системами)
• Экспорт отчетов в PDF, Excel форматы
1.10 Оффлайн-режим и синхронизация
• Оффлайн-работа для критически важных функций (фиксация занятий, ввод данных)
• Автоматическая синхронизация при восстановлении соединения
• Кэширование расписания и данных об инфраструктуре для работы без сети

1.11 Система безопасности и контроля доступа
• Ролевая модель доступа (RBAC)
• Row Level Security в базе данных
• Аудит всех действий пользователей
• Защита персональных данных клиентов
1.12 Мультиплатформенность и адаптивность
• Мобильные приложения для iOS и Android
• Веб-версия для администрации и клиентов
• Адаптивные интерфейсы для разных устройств
• Единая база данных для всех платформ
1.13 Универсальность развёртывания и инфраструктурная независимость
Система разработана с учетом требований малого и среднего бизнеса фитнес-индустрии и обладает максимальной гибкостью в развёртывании:
• Независимость от инфраструктуры: Система может работать на любом стандартном оборудовании без специфических требований к виртуализации или контейнеризации.
• Прямое развёртывание: Установка производится напрямую на операционную систему без промежуточных слоев абстракции.
• Полный контроль данных: Все данные остаются на стороне заказчика, без зависимостей от внешних BaaS-провайдеров.


2 Роли пользователей и их функции в системе
2.2 Клиент.
Пользователь системы, занимающийся в фитнес-центре под руководством тренера.
Функции:
• Аутентификация;
• Ввод антропометрии. Ввод входящих калорий и веса. Ввод предпочтений занятий. Просмотр графиков калорий и веса, просмотр расписания.

2.3 Инструктор.
Помощник тренера. Контролирует занятия, назначенных клиентов.
Функции:
• Аутентификация;
• Просмотр списка назначенных клиентов и открытие карточки клиента из списка;
• Ввод входящих калорий и входящего веса клиента. Просмотр графиков калорий и веса клиента;
• Просмотр расписания клиента, своего расписания и табеля;
• Коррекция плана занятия дня (списка упражнений);
• Фиксация начала и окончания занятия.
• Просмотр списка назначенных тренеров и открытие карточки из списка.

2.4 Тренер.
Тренирует клиентов. Контролирует занятия, назначенных клиентов и инструкторов. Составляет планы тренировок, назначает планы клиентам.
Функции:
• Аутентификация;
• Просмотр списка назначенных клиентов и открытие карточки клиента из списка;
• Ввод входящих калорий и входящего веса клиента. Просмотр графиков калорий и веса клиента;
• Коррекция плана занятия дня (списка упражнений);
• Фиксация начала и окончания занятия.
• Доступ к кнопке "Подобрать прогрессии" в карточке клиента;
• Выбор прогрессии тренировок;
• Смена плана тренировок до первого занятия клиента;
• Просмотр списка прикрепленных инструкторов и открытие карточки из списка.
• Просмотр расписания клиента, своего расписания и табеля, расписание и табель закрепленного инструктора;

2.5 Менеджер.
Контролирует тренировочные бизнес-процессы. Контроль за назначенными клиентами, инструкторами, тренерами.
Функции:
• Аутентификация;
• Ведение записей клиентов, инструкторов, тренеров.
• Ведение расписаний и табелей всех участников бизнес-процесса.
• Ведение обординга клиентов.

2.6 Администратор.
Администрирует систему.
Функции:
• Аутентификация;
• Ведение (просмотр, добавление, удаление, изменение записей) каталогов.
• Ведение записей клиентов, инструкторов, тренеров, менеджеров.
• Ведение расписания работы центра.
• Редактирование настроек системы.

Управление доступом пользователя осуществляется на основе ролей.
В структуре проекта на каждую роль должен отводиться свой модуль-каталог.


3 Система управления группами
3.1 Общие положения
Система управления группами предназначена для организации работы с клиентами фитнес-центра через два принципиально разных типа групп:
    Тренировочные группы (TrainingGroup) - для проведения групповых занятий с фиксированным составом участников
    Аналитические группы (AnalyticGroup) - для сегментации клиентов по различным критериям для аналитики, маркетинга и управления
3.2 Тренировочные группы (TrainingGroup)
3.2.1 Назначение

Тренировочные группы предназначены для организации регулярных групповых занятий с фиксированным составом участников. Они используются в расписании занятий и имеют прямые связи с персоналом, оборудованием и локациями.

3.2.2 Модель данных

class TrainingGroup {
  String id;
  String name;
  String description;
  
  // ПЕРСОНАЛ (обязательные для тренировочного процесса)
  String primaryTrainerId;     // Основной тренер группы (обязательно)
  String? primaryInstructorId; // Основной инструктор группы
  String? responsibleManagerId; // Ответственный менеджер
  
  // СОСТАВ ГРУППЫ (фиксированный)
  List<String> clientIds;      // Фиксированный состав участников
  
  // РАСПИСАНИЕ ЗАНЯТИЙ
  List<GroupScheduleSlot> scheduleSlots;
  
  // ПАРАМЕТРЫ ТРЕНИРОВКИ
  String? programId;           // Ссылка на программу тренировок
  String? goalId;              // Цель тренировок (похудение, набор массы и т.д.)
  String? levelId;             // Уровень подготовки группы
  
  // ЛИМИТЫ И ОГРАНИЧЕНИЯ
  DateTime startDate;          // Дата начала работы группы
  DateTime? endDate;           // Дата окончания (если предусмотрена)
  int maxParticipants;         // Максимальное количество участников
  int currentParticipants;     // Текущее количество участников

  // ПОМЕЩЕНИЕ И ОБОРУДОВАНИЕ
  String? primaryRoomId;     // Основной зал для занятий
  List<String> requiredEquipmentIds; // Необходимое оборудование

  // СТАТУС И СВЯЗИ
  bool isActive;               // Активна ли группа
  String? chatId;              // Ссылка на групповой чат (создается автоматически)
}

3.2.3 Расписание группы (GroupScheduleSlot)

class GroupScheduleSlot {
  String id;
  String groupId;
  int dayOfWeek;          // 1-7 (понедельник-воскресенье)
  TimeOfDay startTime;
  TimeOfDay endTime;
  bool isActive;
}

3.2.4 Правила тренировочных групп

    Фиксированный состав - состав участников изменяется только вручную тренером или менеджером
    Обязательный тренер - каждая группа должна иметь основного тренера
    Четкое расписание - группа имеет расписание занятий на неделю
    Прямое участие в расписании - группа используется при создании занятий в модуле расписания

    Автоматический чат - при создании группы автоматически создается групповой чат

3.2.5 Бизнес-процессы

    Создание группы: Тренер или менеджер создает группу, назначает тренера, настраивает расписание
    Набор участников: Ручное добавление клиентов в группу с проверкой лимита
    Проведение занятий: Занятия создаются на основе расписания группы
    Закрытие группы: При достижении endDate группа переводится в неактивное состояние

   3.3 Аналитические группы (AnalyticGroup)
3.3.1 Назначение

Аналитические группы предназначены для сегментации клиентов по различным критериям для целей:
• Маркетинг и рассылки
• Аналитика и отчетность
• Управление клиентской базой
• Финансовый контроль

3.3.2 Типы аналитических групп

enum AnalyticGroupType {
  corporate,      // Корпоративные клиенты
  demographic,    // Демографические (возраст, пол)
  financial,      // Финансовые (статус оплаты, тип абонемента)
  behavioral,     // Поведенческие (активность, посещаемость)
  custom          // Произвольные (ручное создание)
}

3.3.3 Модель данных

class AnalyticGroup {
  String id;
  String name;
  String description;
  AnalyticGroupType type;
  
  // АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ
  bool isAutoUpdate;           // true - группа автоматически обновляется по условиям
  List<GroupCondition> conditions; // Условия для автоматических групп
  
  // ДИНАМИЧЕСКИЙ СОСТАВ
  List<String> clientIds;      // Кэшированный список клиентов в группе
  DateTime lastUpdatedAt;      // Время последнего обновления
  
  // ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ
  Map<String, dynamic> metadata; // Дополнительные данные по типам
}

3.3.4 Условия для автоматических групп (GroupCondition)

class GroupCondition {
  String field;        // Поле для условия (например, 'age', 'subscription_type')
  String operator;     // Оператор ('equals', 'greater_than', 'less_than', 'contains')
  String value;        // Значение для сравнения
}

3.3.5 Правила аналитических групп

    Динамический состав - состав может обновляться автоматически по условиям
    Нет связи с тренировками - группы не участвуют в расписании занятий
    Для аналитики - используются в отчетах, рассылках, анализе
    Гибкая настройка - могут быть как автоматическими, так и ручными

3.3.6 Бизнес-процессы

    Автоматическое обновление: Система ежедневно пересчитывает состав автоматических групп
    Массовые операции: Рассылки, уведомления для всех участников группы
    Аналитика: Построение отчетов по сегментам клиентов
    Управление: Контроль задолженностей, работа с неактивными клиентами

   3.4 Структура таблиц
3.4.1 Таблица тренировочных групп

CREATE TABLE training_groups (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  
  -- Персонал
  primary_trainer_id BIGINT NOT NULL REFERENCES users(id),
  primary_instructor_id BIGINT REFERENCES users(id),
  responsible_manager_id BIGINT REFERENCES users(id),
  
  -- Программа тренировок
  program_id BIGINT REFERENCES training_plan_templates(id),
  goal_id BIGINT REFERENCES goals_training(id),
  level_id BIGINT REFERENCES levels_training(id),
  
  -- Лимиты
  max_participants INT NOT NULL DEFAULT 15,
  current_participants INT DEFAULT 0,
  
  -- Жизненный цикл
  start_date DATE NOT NULL,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  
  -- Связи
  chat_id BIGINT REFERENCES chats(id),
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id)
);

3.4.2 Таблица расписания групп

CREATE TABLE group_schedule_slots (
  id BIGSERIAL PRIMARY KEY,
  group_id BIGINT NOT NULL REFERENCES training_groups(id),
  day_of_week SMALLINT NOT NULL, -- 1-7
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  is_active BOOLEAN DEFAULT true
);

3.4.3 Таблица участников тренировочных групп 
CREATE TABLE training_group_members (
  id BIGSERIAL PRIMARY KEY,
  training_group_id BIGINT NOT NULL REFERENCES training_groups(id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL REFERENCES users(id),
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  added_by BIGINT REFERENCES users(id),
  UNIQUE(training_group_id, user_id)
);

3.4.4 Таблица аналитических групп (analytic_groups)

CREATE TABLE analytic_groups (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  type SMALLINT NOT NULL, -- 0:corporate, 1:demographic, 2:financial, 3:behavioral, 4:custom
  
  -- Автоматическое обновление
  is_auto_update BOOLEAN DEFAULT false,
  conditions JSONB, -- Условия для автоматических групп
  
  -- Метаданные
  metadata JSONB, -- Дополнительные данные
  
  -- Кэшированный состав
  client_ids_cache JSONB,
  last_updated_at TIMESTAMPTZ,
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id)
);

   3.5 Архитектура и расположение кода
3.5.1 Бэкенд

backend/lib/
├── models/groups/
│   ├── training_group.dart
│   ├── analytic_group.dart
│   ├── group_schedule_slot.dart
│   └── group_condition.dart
├── controllers/groups/
│   ├── training_groups_controller.dart
│   ├── analytic_groups_controller.dart
│   ├── group_schedule_controller.dart
│   └── group_members_controller.dart
└── services/
    └── group_sync_service.dart  # Сервис синхронизации аналитических групп

3.5.2 Фронтенд

frontend/lib/
├── models/groups/
│   ├── training_group.dart
│   ├── analytic_group.dart
│   ├── group_schedule_slot.dart
│   └── group_condition.dart
├── providers/groups/
│   ├── training_groups_provider.dart
│   ├── analytic_groups_provider.dart
│   └── group_schedule_provider.dart
├── screens/admin/groups/
│   ├── training_groups_screen.dart
│   ├── analytic_groups_screen.dart
│   ├── training_group_edit_screen.dart
│   └── analytic_group_edit_screen.dart
└── widgets/groups/
    ├── training_group_card.dart
    ├── analytic_group_card.dart
    └── group_member_list.dart

   3.6 Интеграция с другими модулями
3.6.1 С модулем расписания (раздел 17)

    Тренировочные группы используются при создании групповых занятий
    Автоматическая подстановка тренера, инструктора и состава группы
    Проверка доступности зала и оборудования

3.6.2 С модулем чата (раздел 8)

    При создании тренировочной группы автоматически создается групповой чат
    Участники чата: клиенты группы, тренер, инструктор, менеджер
    Для аналитических групп чаты не создаются автоматически

3.6.3 С модулем отчетности (раздел 9)

    Отчеты по эффективности тренировочных групп
    Аналитика по сегментам клиентов (аналитические группы)
    Отслеживание динамики состава групп

3.6.4 С модулем уведомлений (раздел 7)

    Уведомления о расписании групповых занятий
    Массовые рассылки для аналитических групп
    Напоминания о необходимости продления участия в группе

   3.7 Пользовательские интерфейсы
3.7.1 Дашборд управления группами

    Вкладка "Тренировочные группы" - список групп с возможностью просмотра состава и расписания
    Вкладка "Аналитические группы" - список групп с фильтрами по типам

3.7.2 Форма создания/редактирования тренировочной группы

    Основные параметры (название, описание)
    Выбор тренера, инструктора, менеджера
    Настройка расписания (дни недели, время)
    Установка лимитов и сроков

3.7.3 Форма создания/редактирования аналитической группы

    Выбор типа группы
    Настройка условий для автоматических групп
    Ручной выбор участников для неавтоматических групп
    Настройка дополнительных параметров

   3.8 Ограничения и валидация
3.8.1 Тренировочные группы

    Максимальное количество участников не может быть меньше текущего
    Дата окончания не может быть раньше даты начала
    Обязательное наличие тренера

3.8.2 Аналитические группы

    Условия должны быть корректными и выполнимыми
    Для автоматических групп должен быть хотя бы один участник после обновления
4 
Управление помещениями и оборудованием
4.1 Общие положения
Модуль управления помещениями и оборудованием обеспечивает базовый учёт инфраструктуры фитнес-центра.
• Контроль расположения оборудования
• Управление доступностью залов
• Учёт состояния оборудования
• Интеграция с тренировочным процессом
4.2 Структура помещений
4.2.1 Модель помещения (Room)
dart
class Room {
  String id;
  String name;              // "Зал 1", "Кардио-зона", "Йога-студия"
  String? description;
  RoomType type;            // Тип помещения
  
  // Локация (если многоэтажный центр)
  String? floor;            // "1 этаж"
  String? building;         // "Корпус А"
  
  // Вместимость и параметры
  int maxCapacity;          // Максимальная вместимость (чел.)
  double area;              // Площадь (м²)
  bool hasMirrors;          // Есть зеркала
  bool hasSoundSystem;      // Есть аудиосистема
  
  // Расписание доступности
  TimeOfDay? openTime;      // Время открытия
  TimeOfDay? closeTime;     // Время закрытия
  List<int> workingDays;    // Рабочие дни (1-7)
  
  // Статус
  bool isActive;            // Активно ли помещение
  bool isUnderMaintenance;  // На ремонте
  String? maintenanceNote;  // Причина ремонта
  DateTime? maintenanceUntil; // До какого числа ремонт
  
  // Оборудование в помещении (кэшированный список).
//Список заполняется путем запроса к таблице связи room_equipment.
List<String> equipmentIds;
  
  // Фотографии
  List<String> photoUrls;
  String? floorPlanUrl;     // Схема расстановки
  String? note;
}
4.2.2 Типы помещений (RoomType)
dart
enum RoomType {
  groupHall,      // Зал групповых занятий
  cardioZone,     // Кардио-зона
  strengthZone,   // Силовая зона
  mixedZone,      // Смешанная зона
  studio,         // Студия (йога, пилатес)
  boxingRing,     // Бокс/единоборства
  pool,           // Бассейн
  lockerRoom,     // Раздевалка
  reception,      // Ресепшен
  office,         // Офис
  other           // Прочее
}
4.3 Категории оборудования
4.3.1 Категории оборудования (EquipmentCategory)
dart
enum EquipmentCategory {
  cardio,           // Кардио-оборудование
  strength,         // Силовые тренажёры
  freeWeights,      // Свободные веса
  functional,       // Функциональное оборудование
  accessories,      // Аксессуары
  measurement,      // Измерительное оборудование
  other             // Прочее
}

// Комментарий: Используется только в коде для классификации.
// В БД хранится как SMALLINT. Нет отдельной таблицы категорий.
4.4 Типы оборудования (EquipmentType)
4.4.1 Назначение
Справочник типов оборудования с базовыми характеристиками. 
4.4.2 Модель типа оборудования (EquipmentType)
dart
class EquipmentType {
  String id;
  String name;                // "Гантели", "Беговая дорожка"
  String? description;
  
  // Классификация
  EquipmentCategory category; // Категория (cardio, strength, etc.)
  EquipmentSubType subType;   // Подтип (опционально)
  
  // Базовые характеристики
  String? weightRange;        // "1-30 кг" (для свободных весов)
  String? dimensions;         // "80x150x200 см"
  String? powerRequirements;  // "220V, 2.5kW" (для электрических)
  bool isMobile;              // Мобильное оборудование
  
  // Связи
  String? exerciseTypeId;     // Связь с типом упражнения (type_exercis)
  
  // Медиа
  String? photoUrl;           // Фото оборудования
  String? manualUrl;          // Инструкция (опционально)
  
  // Статус
  bool isActive;              // Активен ли тип
}
4.4.3 Подтипы оборудования (EquipmentSubType)
dart
// Комментарий: Для детализации внутри категорий
// Примеры для cardio: treadmill, elliptical, bike, rower
// Примеры для freeWeights: dumbbell, barbell, kettlebell, plate
// В БД хранится как SMALLINT
4.5 Экземпляры оборудования (EquipmentItem)
4.5.1 Назначение
Учёт конкретных физических единиц оборудования. Каждый экземпляр имеет инвентарный номер и отслеживается индивидуально.
4.5.2 Модель экземпляра оборудования (EquipmentItem)
dart
class EquipmentItem {
  String id;
  String typeId;              // Ссылка на EquipmentType
  String inventoryNumber;     // Внутренний инвентарный номер "ГАН-001"
  String? serialNumber;       // Заводской серийный номер (опционально)
  String? model;              // Модель "Matrix T7xe"
  String? manufacturer;       // Производитель
  
  // Локация
  String? roomId;             // Где находится (ссылка на Room)
  String? placementNote;      // "У окна, рядом с колонной"
  
  // Состояние
  EquipmentStatus status;     // available, inUse, maintenance
  int conditionRating;        // 1-5 (5 = отличное)
  String? conditionNotes;     // "Поцарапана панель, работает нормально"
  
  // Техническое обслуживание (упрощённое)
  DateTime? lastMaintenanceDate;
  DateTime? nextMaintenanceDate;
  String? maintenanceNotes;   // "Заменили ремень"
  
  // Покупка/учёт
  DateTime? purchaseDate;
  double? purchasePrice;
  String? supplier;
  int? warrantyMonths;        // Гарантия в месяцах
  
  // Использование
  int usageHours;             // Накопленные часы использования
  DateTime? lastUsedDate;
  
  // Фотографии конкретного экземпляра
  List<String> photoUrls;
}
4.5.3 Статусы оборудования (EquipmentStatus)
dart
enum EquipmentStatus {
  available,     // Доступно
  inUse,         // Используется (во время занятия)
  reserved,      // Забронировано
  maintenance,   // На обслуживании/ремонте
  outOfOrder,    // Неисправно
  storage,       // На складе
}
4.6 Бронирование оборудования
4.6.1 Модель бронирования (EquipmentBooking)
dart
class EquipmentBooking {
  String id;
  String equipmentItemId;     // Конкретный экземпляр
  String bookedById;          // Кто забронировал (тренер/менеджер)
  
  // Время бронирования
  DateTime startTime;
  DateTime endTime;
  
  // Контекст
  String? lessonId;           // Для какого занятия
  String? trainingGroupId;    // Для какой группы
  String purpose;             // "Групповое занятие", "Индивидуальная тренировка"
  
  // Статус
  BookingStatus status;       // confirmed, active, completed, cancelled
  
  // Дополнительно
  String? notes;              // Особые пожелания
}
4.7 Структура таблиц
4.7.1 Помещения (rooms)
sql
-- Таблица помещений
CREATE TABLE rooms (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  type SMALLINT NOT NULL,           -- RoomType enum
  
  -- Локация
  floor VARCHAR(50),                -- "1 этаж"
  building VARCHAR(100),            -- "Корпус А"
  
  -- Характеристики
  max_capacity INT NOT NULL DEFAULT 10,
  area DECIMAL(5,2),                -- площадь в м²
  has_mirrors BOOLEAN DEFAULT false,
  has_sound_system BOOLEAN DEFAULT false,
  
 
  -- Статус
  is_active BOOLEAN DEFAULT true,
  is_under_maintenance BOOLEAN DEFAULT false,
  maintenance_note TEXT,
  maintenance_until DATE,
  
  -- Файлы
  photo_urls JSONB,
  floor_plan_url TEXT,
  
  -- Системные поля (по требованиям раздела 26)
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id),
  note VARCHAR(100)                -- Заметки
);

-- Индексы для rooms
CREATE INDEX idx_rooms_type ON rooms(type) WHERE is_active = true;
CREATE INDEX idx_rooms_active ON rooms(is_active) WHERE is_active = true;


4.7.2 Типы оборудования (equipment_types)
sql
CREATE TABLE equipment_types (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,      -- "Гантели", "Беговая дорожка"
  description TEXT,
  
  -- Классификация
  category SMALLINT NOT NULL,      -- EquipmentCategory enum
  sub_type SMALLINT,               -- EquipmentSubType enum (опционально)
  
  -- Характеристики
  weight_range VARCHAR(50),        -- "1-30 кг"
  dimensions VARCHAR(100),         -- "80x150x200 см"
  power_requirements VARCHAR(100), -- "220V, 2.5kW"
  is_mobile BOOLEAN DEFAULT true,
  
  -- Связи (для обратной совместимости и интеграции)
  exercise_type_id BIGINT REFERENCES type_exercis(id),
  
  -- Медиа
  photo_url TEXT,
  manual_url TEXT,
  
  -- Статус
  is_active BOOLEAN DEFAULT true,
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id),
  note VARCHAR(100)
);

-- Индексы для equipment_types
CREATE INDEX idx_eq_types_category ON equipment_types(category) WHERE is_active = true;

4.7.3 Экземпляры оборудования (equipment_items)
sql
-- Конкретные экземпляры оборудования
CREATE TABLE equipment_items (
  id BIGSERIAL PRIMARY KEY,
  
  -- Тип оборудования
  type_id BIGINT NOT NULL REFERENCES equipment_types(id),
  
  -- Идентификация
  inventory_number VARCHAR(50) NOT NULL UNIQUE,  -- "ГАН-001"
  serial_number VARCHAR(100),                    -- Заводской номер
  model VARCHAR(100),                            -- "Matrix T7xe"
  manufacturer VARCHAR(255),                     -- "Johnson Health Tech"
  
  -- Локация
  room_id BIGINT REFERENCES rooms(id),
  placement_note TEXT,
  
  -- Состояние
  status SMALLINT DEFAULT 0,                     -- EquipmentStatus enum
  condition_rating INT CHECK (condition_rating >= 1 AND condition_rating <= 5),
  condition_notes TEXT,
  
  -- Обслуживание (упрощённое)
  last_maintenance_date DATE,
  next_maintenance_date DATE,
  maintenance_notes TEXT,
  
  -- Учёт
  purchase_date DATE,
  purchase_price DECIMAL(10,2),
  supplier VARCHAR(255),
  warranty_months INT,
  
  -- Использование
  usage_hours INT DEFAULT 0,
  last_used_date DATE,
  
  -- Фотографии
  photo_urls JSONB,
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id),
  note VARCHAR(100)
);

-- Индексы для equipment_items
CREATE INDEX idx_eq_items_type ON equipment_items(type_id);
CREATE INDEX idx_eq_items_room ON equipment_items(room_id) WHERE room_id IS NOT NULL;
CREATE INDEX idx_eq_items_status ON equipment_items(status) WHERE status = 0; -- available
CREATE INDEX idx_eq_items_inventory ON equipment_items(inventory_number);

4.7.4 Таблица связи помещения и оборудования
CREATE TABLE room_equipment (
  id BIGSERIAL PRIMARY KEY,
  room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
  equipment_item_id BIGINT NOT NULL REFERENCES equipment_items(id) ON DELETE CASCADE,
  -- quantity INT DEFAULT 1, -- Опционально: если одинаковых единиц несколько
  placement_note TEXT, -- Опционально: "У окна", "У зеркала"
  UNIQUE(room_id, equipment_item_id) -- Чтобы не было дубликатов связей
);

-- Индексы для быстрого поиска
CREATE INDEX idx_room_equipment_room ON room_equipment(room_id);
CREATE INDEX idx_room_equipment_item ON room_equipment(equipment_item_id);

Пример запроса для получения помещения со списком оборудования:
-- 1. Получить данные помещения
SELECT * FROM rooms WHERE id = 123;
-- 2. Получить ID оборудования для этого помещения
SELECT equipment_item_id FROM room_equipment WHERE room_id = 123;

4.7.5 Бронирование оборудования (equipment_bookings)
sql
-- Бронирование конкретного оборудования
CREATE TABLE equipment_bookings (
  id BIGSERIAL PRIMARY KEY,
  
  -- Что бронируем
  equipment_item_id BIGINT NOT NULL REFERENCES equipment_items(id),
  
  -- Кто бронирует
  booked_by BIGINT NOT NULL REFERENCES users(id),
  
  -- Время
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ NOT NULL,
  
  -- Контекст
  lesson_id BIGINT REFERENCES lessons(id),
  training_group_id BIGINT REFERENCES training_groups(id),
  purpose VARCHAR(255) NOT NULL,
  
  -- Статус
  status SMALLINT DEFAULT 0,  -- BookingStatus enum
  
  -- Дополнительно
  notes TEXT,
  
  -- Системные поля
  company_id BIGINT DEFAULT -1,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by BIGINT REFERENCES users(id),
  updated_by BIGINT REFERENCES users(id),
  archived_at TIMESTAMPTZ,
  archived_by BIGINT REFERENCES users(id),
  
  -- Ограничения
  CONSTRAINT valid_booking_time CHECK (end_time > start_time)
);

-- Индекс для проверки пересечений бронирований
CREATE INDEX idx_eq_bookings_time 
ON equipment_bookings(equipment_item_id, start_time, end_time) 
WHERE status IN (0, 1); -- confirmed, active
4.8 Бизнес-правила
4.8.1 Бронирование помещений и оборудования
1. При создании занятия система проверяет доступность зала
2. Если для занятия требуется оборудование - проверяет его доступность
3. Приоритет бронирования:
o Регулярные занятия тренировочных групп
o Индивидуальные занятия
o Разовые мероприятия
4.8.2 Управление состоянием оборудования
1. Оборудование со статусом maintenance или outOfOrder не бронируется
2. При достижении next_maintenance_date система уведомляет ответственного
3. После ремонта обязательна отметка о проведённых работах
4.8.3 Инвентаризация
1. Раз в месяц проводится сверка оборудования
2. Отсутствующее оборудование отмечается статусом
3. Ответственность за оборудование лежит на менеджере зала
4.9 Интеграция с существующими модулями
4.9.1 С тренировочными группами (TrainingGroup)
dart
class TrainingGroup {
  // ... существующие поля
  
  String? primaryRoomId;     // Основной зал для занятий группы
  List<String> requiredEquipmentTypeIds; // Типы необходимого оборудования
}
4.9.2 С расписанием занятий (раздел 17)
При создании занятия в таблицу lessons добавляются:
sql
ALTER TABLE lessons ADD COLUMN room_id BIGINT REFERENCES rooms(id);
ALTER TABLE lessons ADD COLUMN equipment_booking_ids JSONB; -- IDs из equipment_bookings
4.9.3 С системой уведомлений (раздел 7)
• Уведомления о необходимости ТО оборудования
• Напоминания о бронировании залов
• Предупреждения о конфликтах расписания
4.9.4 С каталогом упражнений
Существующая связь сохраняется:
text
exercises_templates → type_exercis_id → equipment_types (через exercise_type_id)
4.10 API endpoints
4.10.1 Помещения
text
GET    /api/rooms                    # Список помещений
GET    /api/rooms/:id               # Детали помещения
POST   /api/rooms                   # Создать помещение
PUT    /api/rooms/:id               # Обновить помещение
GET    /api/rooms/availability      # Проверить доступность
GET    /api/rooms/:id/equipment     # Оборудование в помещении
4.10.2 Оборудование
text
GET    /api/equipment/types         # Типы оборудования
GET    /api/equipment/items         # Экземпляры оборудования
GET    /api/equipment/items/:id     # Детали экземпляра
POST   /api/equipment/items         # Создать экземпляр
PUT    /api/equipment/items/:id     # Обновить экземпляр
PUT    /api/equipment/items/:id/maintenance # Отметить ТО
GET    /api/equipment/availability  # Доступное оборудование
4.10.3 Бронирование
text
GET    /api/bookings/equipment      # Бронирования оборудования
POST   /api/bookings/equipment      # Создать бронирование
PUT    /api/bookings/equipment/:id/cancel # Отменить бронирование
GET    /api/bookings/conflicts      # Проверить конфликты
4.11 Пользовательские интерфейсы
4.11.1	Меню и правила
• Меню вызова всех списков и дашбордов помещений, находится в дашбордах сотрудников, в меню->Каталоги->Помещения. Операции добавления, редактирования, архивирования, доступны только админу. Бронирование доступно менеджеру, тренеру и инструктору только просмотр.
• Меню вызова всех списков и дашбордов оборудования, находится в дашбордах сотрудников, в меню->Каталоги->Оборудование. Роли Тренер и Инструктор имеют доступ только чтение.
4.11.2	Дашборд управления инфраструктурой (Infrastructure Dashboard)

1. Верхняя панель с KPI:
   • Всего помещений: X
   • Залы в работе: Y
   • На ремонте: Z
   • Оборудование доступно: N
   • Требует ТО: M

2. Карта залов (визуальное представление):
   • Иконки залов с цветовой индикацией:
     - Зеленый: свободен
     - Желтый: частично занят
     - Красный: полностью занят
     - Серый: на ремонте
   • При клике на зал - всплывающая карточка с деталями

3. Быстрые действия:
   • Добавить помещение
   • Забронировать зал
   • Смотреть расписание

4.11.3 Список помещений (Rooms ListView)
Заголовок: "Помещения"

Панель инструментов:
• Кнопка "Создать помещение"
• Поле поиска по названию
• Фильтры:
  - Тип помещения: Все / Групповые залы / Кардио-зоны / и т.д.
  - Этаж: Все / 1 этаж / 2 этаж
  - Статус: Все / Активные / На ремонте

Отображаемые колонки:
1. Фото (первое фото из photo_urls, миниатюра)
2. Название (кликабельно - открывает карточку)
3. Тип (иконка + название типа)
4. Вместимость (max_capacity чел.)
5. Площадь (area м²)
6. Статус:
   - Зеленый бейдж "Активно"
   - Оранжевый бейдж "На ремонте"
7. Занятость (прогресс-бар с % занятости на текущий день)
8. Действия (иконки):
   - 👁️ Просмотр
   - ✏️ Редактировать
   - 📋 Бронировать
   - 🗑️ Архивировать

4.11.4 Карточка помещения (Room Detail Card)
Открывается при клике на помещение в списке

1. Верхняя часть:
   • Карусель фотографий (photo_urls)
   • Кнопка "Добавить фото"
   • Схема расстановки (floor_plan_url, если есть)

2. Основная информация (табы):
   Таб "Основное":
   • Название (редактируемое)
   • Тип (выпадающий список)
   • Описание (textarea)
   • Этаж, Корпус (текстовые поля)
   • Вместимость, Площадь (числовые поля)
   • Чекбоксы: Зеркала, Аудиосистема

   Таб "Расписание":
   • Время работы: open_time - close_time
   • Рабочие дни: чекбоксы дней недели
   • Календарь бронирований на текущую неделю

   Таб "Состояние":
   • Статус: Активно / На ремонте (переключатель)
   • При ремонте: причина (textarea), дата окончания (date picker)

   Таб "Оборудование":
   • Список оборудования в этом помещении
   • Кнопка "Добавить оборудование" - выбор из списка свободного оборудования

   Таб "Статистика":
   • График загрузки зала по дням недели
   • Количество проведенных занятий за месяц
   • Средняя заполняемость (%)

3. Кнопки действий внизу:
   • Сохранить
   • Отменить
   • Архивировать


4.11.5 Дашборд оборудования (Equipment Dashboard)
Назначение:
Главный экран управления оборудованием, предоставляющий сводку и быстрый доступ ко всем функциям модуля.
Интерфейс:
1. Панель ключевых показателей (KPI) вверху:
o Всего оборудования: [число]
o Доступно: [число] ([процент]%)
o В использовании: [число]
o На ТО: [число]
o Неисправно: [число]
2. Навигационные кнопки (крупные, в виде карточек):
o "Типы оборудования" – переход к списку типов оборудования (раздел 4.11.6)
o "Экземпляры оборудования" – переход к списку экземпляров (раздел 4.11.7)
o "Бронирования" – переход к списку/календарю бронирований
o "Отчеты по оборудованию" – переход к отчетам (раздел 4.11.12)
3. Быстрые действия (кнопки):
o "Добавить оборудование" (ведет к форме создания экземпляра)
o "Забронировать оборудование" (открывает форму бронирования)
o "Отметить ТО" (быстрая форма для отметки обслуживания)
o "Сканировать QR" (открывает сканер QR-кодов)
4. Быстрое меню (виджеты):
o "Требует внимания" – список оборудования, у которого скоро плановое ТО или статус "неисправно"
o "Последние добавленные" – несколько последних добавленных единиц оборудования
o "Ближайшие бронирования" – сегодняшние и завтрашние бронирования
Адаптивность:
На мобильных устройствах панель KPI может превращаться в горизонтально прокручиваемую полосу, а навигационные кнопки располагаются вертикально в один столбец.
4.11.6 Список типов оборудования (Equipment Types ListView)
Переход по кнопке "Типы оборудования"
Заголовок: "Типы оборудования"
Панель инструментов:
• Кнопка "Создать тип"
• Поиск по названию
• Фильтры по категории (cardio, strength, etc.)
Отображаемые колонки (на десктопе) / карточки (на мобильном):
1. Фото (photo_url, миниатюра)
2. Название (кликабельно)
3. Категория (бейдж с цветом категории)
4. Подтип (если есть)
5. Характеристики: вес, габариты (сокращенно)
6. Активен (зеленый/красный индикатор)
7. Действия: Просмотр, Редактировать, Архивировать
4.11.7 Список экземпляров оборудования (Equipment Items ListView)
Переход по кнопке "Экземпляры оборудования"
Заголовок: "Оборудование"
Панель инструментов:
• Кнопка "Добавить оборудование"
• Расширенный поиск: по инв. номеру, модели, производителю
• Фильтры:
o По типу оборудования
o По статусу: Доступно / В использовании / На ТО / Неисправно
o По помещению (где находится)
o По состоянию (рейтинг 1-5)
Отображаемые колонки (на десктопе) / карточки (на мобильном):
1. Фото (миниатюра из photo_urls или фото типа)
2. Инвентарный номер (жирный, кликабельно)
3. Тип оборудования (название)
4. Модель / Производитель
5. Местоположение (название помещения, если назначено)
6. Статус (цветной бейдж):
o Зеленый: "Доступно"
o Синий: "В использовании"
o Желтый: "Забронировано"
o Оранжевый: "На ТО"
o Красный: "Неисправно"
7. Состояние (звезды рейтинга 1-5)
8. Действия:
o 👁️ Просмотр
o ✏️ Редактировать
o 📋 Бронировать
o 🔧 Отметить ТО
o 🗑️ Архивировать


4.11.8 Карточка экземпляра оборудования (Equipment Item Detail Card)
1. Верхняя часть:
   • Фотографии экземпляра (карусель)
   • Кнопка "Добавить фото"

2. Основная информация (табы):
   Таб "Основное":
   • Тип оборудования (выпадающий список, ссылка на тип)
   • Инвентарный номер (уникальный, редактируется только при создании)
   • Серийный номер, модель, производитель
   • Местоположение (выпадающий список помещений)
   • Примечание к размещению

   Таб "Состояние":
   • Статус (выпадающий список)
   • Оценка состояния (звезды 1-5)
   • Заметки о состоянии
   • История ТО: таблица с датами, типом работ, исполнителем

   Таб "Учет":
   • Дата покупки, цена, поставщик
   • Гарантия (месяцев)
   • Накопленные часы использования
   • Дата последнего использования

   Таб "Бронирования":
   • Календарь бронирований на месяц
   • Список предстоящих бронирований
   • Кнопка "Забронировать"

   Таб "Использование":
   • График использования (часы/день за последние 30 дней)
   • Статистика: всего часов, среднее в день

3. Быстрые действия:
   • "Забронировать" - открывает форму бронирования с предзаполненным оборудованием
   • "Отметить ТО" - быстрая форма для отметки обслуживания
   • "Изменить статус" - выпадающий список статусов

4.11.9 Форма бронирования оборудования/помещения
Модальное окно/отдельный экран

1. Выбор типа ресурса:
   • Радиокнопки: "Зал" / "Оборудование"

2. Поля формы:
   • Ресурс: выпадающий список (динамически меняется в зависимости от типа)
     - Для залов: список активных залов
     - Для оборудования: список доступного оборудования
   • Дата: date picker (по умолчанию сегодня)
   • Время начала: time picker
   • Время окончания: time picker (автоматически +1 час от начала)
   • Длительность: расчетное поле (вычисляется автоматически)
   • Цель бронирования: выпадающий список:
     - Групповое занятие
     - Индивидуальная тренировка
     - Техническое обслуживание
     - Мероприятие
     - Другое
   • Связанный объект (если применимо):
     - Для занятия: выбор клиента/группы
     - Для ТО: выбор сотрудника
   • Примечание: textarea

3. Проверка доступности:
   • Кнопка "Проверить доступность"
   • При наличии конфликтов - предупреждение со списком пересечений
   • При свободном времени - сообщение "Время доступно"

4. Кнопки действий:
   • "Забронировать" (становится активной после успешной проверки)
   • "Отмена"

4.11.10 Дашборд занятости (Occupancy Dashboard)

1. Вид календаря:
   • Переключение между днями/неделями/месяцами
   • Сетка: по вертикали - помещения, по горизонтали - время

2. Цветовая кодировка:
   • Белый: свободно
   • Светло-зеленый: частично занято
   • Зеленый: занято (индивидуальное занятие)
   • Синий: занято (групповое занятие)
   • Красный: конфликт/пересечение
   • Серый: нерабочее время/ремонт

3. Интерактивность:
   • При наведении на ячейку - всплывающая подсказка с деталями бронирования
   • При клике - открывается карточка бронирования
   • Drag & drop для переноса бронирований

4. Фильтры:
   • Выбор помещений (можно выбрать несколько)
   • Тип занятий: Все / Групповые / Индивидуальные
   • Период: день/неделя/месяц

5. Экспорт:
   • Кнопка "Экспорт в PDF" - расписание на выбранный период
   • Кнопка "Экспорт в Excel" - детализированный отчет

4.11.11 Панель состояния оборудования (Equipment Status Panel)

1. Ключевые метрики:
   • Всего оборудования: X
   • Доступно: Y (Z%)
   • В использовании: A
   • На ТО: B
   • Неисправно: C

2. Виджеты:
   Виджет "Требует ТО":
   • Список оборудования с подходящим сроком next_maintenance_date
   • Сортировка по срочности (ближайшие даты сверху)
   • Кнопка "Отметить как обслуженное"

   Виджет "Неисправное оборудование":
   • Список оборудования со статусом "outOfOrder"
   • Дата установки статуса
   • Причина неисправности
   • Кнопка "Начать ремонт"

   Виджет "Наиболее используемое":
   • Топ-10 оборудования по usage_hours
   • Прогресс-бар использования

   Виджет "Предстоящие бронирования":
   • Ближайшие бронирования оборудования на сегодня/завтра
   • Возможность быстрой отмены


4.11.12 Отчеты и аналитика
Доступны в разделе "Отчетность" (раздел 8), но дублируются в модуле оборудования

1. Отчет "Загрузка помещений":
   • Таблица с помещениями и % загрузки за период
   • График загрузки по дням недели
   • Сравнение с предыдущим периодом

2. Отчет "Использование оборудования":
   • Часы использования по типам оборудования
   • Стоимость часа использования (амортизация)
   • Рентабельность оборудования

3. Отчет "Техническое обслуживание":
   • Количество ТО за период
   • Затраты на обслуживание
   • Среднее время между отказами (MTBF)

4.11.13 Настройки модуля
Доступны только Администратору

1. Параметры:
   • Время работы по умолчанию для новых помещений
   • Длительность бронирования по умолчанию
   • Период напоминания о ТО (дней до next_maintenance_date)
   • Политика бронирования (максимальное время, приоритеты)

2. Категории и типы:
   • Управление EquipmentCategory enum (только через код)
   • Управление EquipmentSubType (только через код)
   • Настройка цветовых схем для статусов

4.11.14 Архитектура интерфейсов
Бэкенд архитектура (backend):
backend/lib/modules/infrastructure/
├── models/
│   ├── room/                           # Модели помещений
│   │   ├── room.model.dart
│   │   ├── room_type.enum.dart
│   │   └── room_dto.dart
│   ├── equipment/                      # Модели оборудования
│   │   ├── equipment_type.model.dart
│   │   ├── equipment_item.model.dart
│   │   ├── equipment_category.enum.dart
│   │   ├── equipment_status.enum.dart
│   │   └── equipment_dto.dart
│   └── booking/                        # Модели бронирований
│       ├── equipment_booking.model.dart
│       ├── booking_status.enum.dart
│       └── booking_dto.dart
├── controllers/
│   ├── room.controller.dart            # Контроллер помещений
│   ├── equipment_type.controller.dart  # Контроллер типов оборудования
│   ├── equipment_item.controller.dart  # Контроллер экземпляров оборудования
│   └── booking.controller.dart         # Контроллер бронирований
├── services/
│   ├── room.service.dart              # Сервис помещений
│   ├── equipment.service.dart         # Сервис оборудования
│   ├── booking.service.dart           # Сервис бронирований
│   ├── availability.service.dart      # Сервис проверки доступности
│   └── maintenance.service.dart       # Сервис техобслуживания
├── repositories/
│   ├── room.repository.dart           # Репозиторий помещений
│   ├── equipment_type.repository.dart # Репозиторий типов оборудования
│   ├── equipment_item.repository.dart # Репозиторий экземпляров оборудования
│   └── booking.repository.dart        # Репозиторий бронирований
└── validators/
    ├── room.validator.dart            # Валидаторы помещений
    ├── equipment.validator.dart       # Валидаторы оборудования
    └── booking.validator.dart         # Валидаторы бронирований

Фронтенд архитектура (frontend):
frontend/lib/modules/infrastructure/
├── screens/
│   ├── dashboard/
│   │   └── infrastructure_dashboard_screen.dart      # Дашборд инфраструктуры
│   ├── room/
│   │   ├── rooms_list_screen.dart                   # Список помещений
│   │   ├── room_detail_screen.dart                  # Карточка помещения
│   │   ├── room_edit_screen.dart                    # Редактирование помещения
│   │   └── room_create_screen.dart                  # Создание помещения
│   ├── equipment/
│   │   ├── type/
│   │   │   ├── equipment_types_list_screen.dart     # Список типов оборудования
│   │   │   ├── equipment_type_detail_screen.dart    # Карточка типа оборудования
│   │   │   └── equipment_type_edit_screen.dart      # Редактирование типа
│   │   └── item/
│   │       ├── equipment_items_list_screen.dart     # Список экземпляров оборудования
│   │       ├── equipment_item_detail_screen.dart    # Карточка экземпляра
│   │       ├── equipment_item_edit_screen.dart      # Редактирование экземпляра
│   │       └── equipment_item_create_screen.dart    # Создание экземпляра
│   ├── booking/
│   │   ├── booking_list_screen.dart                 # Список бронирований
│   │   ├── booking_detail_screen.dart               # Карточка бронирования
│   │   ├── booking_create_screen.dart               # Создание бронирования
│   │   ├── booking_edit_screen.dart                 # Редактирование бронирования
│   │   └── booking_calendar_screen.dart             # Календарь бронирований
│   ├── occupancy/
│   │   ├── occupancy_calendar_screen.dart           # Календарь занятости
│   │   └── occupancy_report_screen.dart             # Отчет по занятости
│   └── maintenance/
│       ├── maintenance_list_screen.dart             # Список ТО
│       ├── maintenance_detail_screen.dart           # Карточка ТО
│       └── maintenance_schedule_screen.dart         # График ТО
├── widgets/
│   ├── room/
│   │   ├── room_card.dart                          # Карточка помещения в списке
│   │   ├── room_status_badge.dart                  # Бейдж статуса помещения
│   │   ├── room_type_chip.dart                     # Чип типа помещения
│   │   ├── room_photos_carousel.dart               # Карусель фотографий помещения
│   │   └── room_capacity_indicator.dart            # Индикатор вместимости
│   ├── equipment/
│   │   ├── equipment_card.dart                     # Карточка оборудования в списке
│   │   ├── equipment_status_badge.dart             # Бейдж статуса оборудования
│   │   ├── equipment_category_chip.dart            # Чип категории оборудования
│   │   ├── equipment_condition_stars.dart          # Звезды состояния
│   │   ├── equipment_photos_carousel.dart          # Карусель фотографий оборудования
│   │   └── equipment_quick_actions.dart            # Быстрые действия с оборудованием
│   ├── booking/
│   │   ├── booking_card.dart                       # Карточка бронирования в списке
│   │   ├── booking_status_badge.dart               # Бейдж статуса бронирования
│   │   ├── booking_calendar_widget.dart            # Виджет календаря бронирований
│   │   ├── booking_conflict_warning.dart           # Предупреждение о конфликте
│   │   └── booking_timeline.dart                   # Таймлайн бронирований
│   ├── occupancy/
│   │   ├── occupancy_grid.dart                     # Сетка занятости
│   │   ├── occupancy_timeline.dart                 # Таймлайн занятости
│   │   ├── occupancy_legend.dart                   # Легенда занятости
│   │   └── occupancy_stats_card.dart               # Карточка статистики занятости
│   └── shared/
│       ├── qr_scanner_widget.dart                  # Сканер QR-кодов
│       ├── availability_checker.dart               # Проверка доступности
│       ├── resource_picker.dart                    # Выбор ресурса (помещение/оборудование)
│       └── time_slot_picker.dart                   # Выбор временного слота
├── models/
│   ├── room/
│   │   ├── room.model.dart                         # Модель помещения
│   │   ├── room_type.enum.dart                     # Enum типа помещения
│   │   └── room_filter.model.dart                  # Модель фильтра помещений
│   ├── equipment/
│   │   ├── equipment_type.model.dart               # Модель типа оборудования
│   │   ├── equipment_item.model.dart               # Модель экземпляра оборудования
│   │   ├── equipment_category.enum.dart            # Enum категории оборудования
│   │   ├── equipment_status.enum.dart              # Enum статуса оборудования
│   │   └── equipment_filter.model.dart             # Модель фильтра оборудования
│   └── booking/
│       ├── equipment_booking.model.dart            # Модель бронирования оборудования
│       ├── booking_status.enum.dart                # Enum статуса бронирования
│       └── booking_filter.model.dart               # Модель фильтра бронирований
├── providers/
│   ├── room/
│   │   ├── room_provider.dart                      # Провайдер помещений
│   │   ├── room_filter_provider.dart               # Провайдер фильтров помещений
│   │   └── room_availability_provider.dart         # Провайдер доступности помещений
│   ├── equipment/
│   │   ├── equipment_type_provider.dart            # Провайдер типов оборудования
│   │   ├── equipment_item_provider.dart            # Провайдер экземпляров оборудования
│   │   ├── equipment_filter_provider.dart          # Провайдер фильтров оборудования
│   │   └── equipment_availability_provider.dart    # Провайдер доступности оборудования
│   ├── booking/
│   │   ├── booking_provider.dart                   # Провайдер бронирований
│   │   ├── booking_filter_provider.dart            # Провайдер фильтров бронирований
│   │   └── booking_conflict_provider.dart          # Провайдер проверки конфликтов
│   └── infrastructure/
│       ├── infrastructure_stats_provider.dart      # Провайдер статистики инфраструктуры
│       └── maintenance_provider.dart               # Провайдер техобслуживания
├── services/
│   ├── room_service.dart                          # Сервис работы с помещениями
│   ├── equipment_service.dart                     # Сервис работы с оборудованием
│   ├── booking_service.dart                       # Сервис работы с бронированиями
│   ├── availability_service.dart                  # Сервис проверки доступности
│   ├── maintenance_service.dart                   # Сервис техобслуживания
│   └── qr_service.dart                            # Сервис работы с QR-кодами
└── utils/
    ├── room_utils.dart                            # Утилиты для работы с помещениями
    ├── equipment_utils.dart                       # Утилиты для работы с оборудованием
    ├── booking_utils.dart                         # Утилиты для работы с бронированиями
    ├── occupancy_calculator.dart                  # Калькулятор занятости
    └── infrastructure_formatters.dart             # Форматтеры для инфраструктуры

Мобильный интерфейс (для инструкторов/тренеров):
frontend/lib/modules/infrastructure/mobile/
├── screens/
│   ├── mobile_infrastructure_dashboard.dart       # Мобильный дашборд
│   ├── mobile_room_list.dart                      # Мобильный список помещений
│   ├── mobile_equipment_list.dart                 # Мобильный список оборудования
│   ├── mobile_quick_booking.dart                  # Быстрое бронирование
│   └── mobile_qr_scanner.dart                     # Сканер QR-кодов
└── widgets/
    ├── mobile_room_card.dart                      # Мобильная карточка помещения
    ├── mobile_equipment_card.dart                 # Мобильная карточка оборудования
    ├── mobile_booking_form.dart                   # Мобильная форма бронирования
    └── mobile_status_badge.dart                   # Мобильный бейдж статуса

Интеграционные компоненты:
frontend/lib/modules/infrastructure/integration/
├── training_group_integration.dart                # Интеграция с тренировочными группами
├── schedule_integration.dart                      # Интеграция с расписанием
├── notification_integration.dart                  # Интеграция с уведомлениями
└── reporting_integration.dart                     # Интеграция с отчетностью

Навигация:
frontend/lib/modules/infrastructure/navigation/
├── infrastructure_routes.dart                     # Маршруты модуля инфраструктуры
├── room_routes.dart                              # Маршруты для помещений
├── equipment_routes.dart                         # Маршруты для оборудования
├── booking_routes.dart                           # Маршруты для бронирований
└── infrastructure_bottom_nav.dart                # Нижняя навигация для инфраструктуры
    


5 Онбординг (Lead Management)
5.1 Управление лидами
1-й способ холодного контакта. Потенциальный клиент оставляет заявку на сайте компании через контейнер "Составить заявку". Система автоматически создает запись в каталоге "Заявки (Лид-менеджмент)" (onboarding_client) и уведомляет дежурного менеджера.
2-й способ холодного контакта. Менеджер вручную создает запись в каталоге "Заявки" после телефонного разговора.
Менеджер связывается с лидом для консультации. Результаты общения фиксируются в поле "Примечание менеджера" карточки лида.
5.2 Активация учетной записи клиента
После достижения договоренности менеджер в карточке лида нажимает кнопку "Отправить приглашение".
1. Генерация приглашения: Система создает уникальную одноразовую ссылку-приглашение с JWT-токеном, содержащим id записи лида. Ссылка действительна 72 часа.
2. Отправка уведомления: Ссылка отправляется лиду по тому каналу связи, который был указан как предпочтительный (email или SMS). Текст уведомления настраивается администратором.
3. Завершение регистрации: Лид переходит по ссылке, попадает на защищенную страницу, где должен задать свой пароль для системы. Пароль должен соответствовать политике безопасности.
4. Создание клиента: После успешной установки пароля система в рамках одной транзакции:
o Создает полноценную учетную запись User с ролью "Клиент", используя данные из onboarding_client.
o Помечает запись в onboarding_client как is_client_created = true.
o Автоматически аутентифицирует пользователя в системе и перенаправляет его в личный кабинет.
5. Обработка просрочки: Если ссылка истекла, клиент должен обратиться к менеджеру для генерации новой.

5.3 Диаграмма состояний для онбординга

Пояснения к диаграмме и процессу
Ключевые состояния:
1. NewLead (Новая заявка): Начальное состояние. Заявка создана (через сайт или менеджером), но еще не взята в работу.
o Подсостояние «ОжиданиеОбработки»: Заявка в очереди на менеджера.
o Подсостояние «Обработка»: Менеджер активно работает с лидом (звонок, консультация).
2. Обработка: Менеджер связался с лидом, идет этап консультации.
o Подсостояние «Консультация»: Идет общение.
o Подсостояние «ОжиданиеРешения»: Менеджер ждет ответа от клиента или принимает решение.
3. Отклонена (Archived): Конечное состояние. Заявка неактивна (клиент не заинтересовался, не вышел на связь).
4. ПриглашениеОтправлено: Ключевое состояние. Менеджер подтвердил согласие клиента, система сгенерировала и отправила ссылку-приглашение.
o Подсостояние «ОжиданиеРегистрации»: Ссылка активна, система ждет действия от клиента.
o Подсостояние «Просрочено»: Ссылка истекла (прошло >72 часов). Требуется действие менеджера. Возможен вариант повторной отправки приглашения: создается новая ссылка с новым TTL, а старые инвалидируются.
5. АктивныйКлиент (Client Created): Конечное состояние, цель процесса. Лид успешно зарегистрировался в системе, учетная запись пользователя создана.
Ключевые события (переходы):
• "Менеджер отправляет новое приглашение" из состояния Просрочено позволяет повторно активировать заявку, не создавая новую запись.
• "Лид переходит по ссылке" — это автоматическое событие, инициируемое клиентом, которое запускает процесс регистрации и финального перехода в статус АктивныйКлиент.
• "Менеджер архивирует заявку" — это ручное действие менеджера для очистки базы от неактивных просроченных заявок.

6 Подсистема уведомлений (Notification Service)
Подсистема уведомлений отвечает за своевременную отправку сообщений пользователям через различные каналы связи (Email, SMS, Push) в соответствии с их настройками и бизнес-событиями системы.
6.1 Архитектура и общие требования
• Централизованный сервис: Уведомления должны обрабатываться единым сервисом (отдельным Dart-модулем), который получает события от системы и управляет очередью отправки.
• Шаблоны сообщений: Тексты уведомлений должны храниться в базе данных в виде шаблонов с возможностями подстановки переменных (например, {{client_name}}, {{training_time}}). Это позволит администратору изменять тексты без изменения кода.
• Очередь отправки (Queue): Для надежности отправка должна использовать очередь сообщений, чтобы избежать потери уведомлений при сбоях в работе внешних сервисов (SMTP, SMS-шлюз).
• Логирование: Отправка каждого уведомления должна фиксироваться в отдельной таблице.
6.2 Типы уведомлений (Бизнес-события)
Система должна отправлять уведомления при наступлении следующих событий:
1. Приглашение клиента:
o Событие: Менеджер нажал "Отправить приглашение" в карточке лида.
o Канал: Email или SMS (в зависимости от данных лида).
o Получатель: Потенциальный клиент (запись в onboarding_client).
o Содержание: Приветствие, уникальная ссылка для активации, инструкция.
2. Напоминание о занятии:
o Событие: За hourNotification часов до начала занятия.
o Триггер: Система проверяет расписание каждые 15 минут.
o Канал: Push-уведомление в приложении (основной), дублирование на Email (опционально, по настройкам пользователя).
o Получатель: Клиент, Тренер, Инструктор (привязанные к занятию).
o Содержание: Время занятия, название плана тренировок, ссылка на карточку занятия.
3. Изменение в расписании:
o Событие: Тренер или менеджер изменил время/дату занятия, отменил его.
o Канал: Push-уведомление, Email.
o Получатель: Клиент, Тренер, Инструктор.
o Содержание: Информация об изменении, старое и новое время.
4. Новое сообщение в чате:
o Событие: Пользователь отправил сообщение в чат (Peer-to-Peer или Broadcast).
o Канал: Push-уведомление.
o Получатель: Участник(и) чата, которые в данный момент не в приложении.
o Содержание: Имя отправителя и начало текста сообщения.
5. Системные уведомления для персонала:
o Событие: Поступление новой заявки с сайта (onboarding_client).
o Канал: Push-уведомление, Email.
o Получатель: Дежурный менеджер.
o Содержание: "Поступила новая заявка от [Имя]".
o Уведомления о необходимости обслуживания оборудования
o Предупреждения о конфликтах бронирования
o Напоминания о плановом ТО
6.3 Управление подписками (Пользовательские настройки)
Каждый пользователь (в дашборде "Настройки") должен иметь возможность независимо настраивать получение уведомлений:
• Общий переключатель: sendNotification (Вкл/Выкл все уведомления).
• Время напоминания о занятии: hourNotification (в часах).
• Каналы для разных событий: Отдельные переключатели для получения уведомлений по каналам:
o Push-уведомления (всегда Вкл, если не выключены на уровне ОС).
o Email-уведомления (опционально).
o SMS-уведомления (опционально, может быть платной услугой).
6.4 Технологический стек
- **Очередь задач:** Redis Queue или пакет dart_redis
- **Шаблоны сообщений:** PostgreSQL + Handlebars-подобный движок
- **Email отправка:** SMTP сервер (Postfix или внешний провайдер)
- **SMS отправка:** REST API российских SMS-шлюзов
- **Push-уведомления:** Firebase Cloud Messaging (FCM) для мобильных приложений
- **Веб-уведомления:** WebSocket + Service Worker

6.5 Компоненты системы
notification_service/
├── lib/
│   ├── notification_queue.dart    # Очередь уведомлений
│   ├── email_sender.dart         # Отправка email
│   ├── sms_sender.dart           # Отправка SMS
│   ├── push_sender.dart          # Push-уведомления
│   ├── template_engine.dart      # Шаблонизатор
│   └── webhook_sender.dart       # Webhook-уведомления
├── config/
│   ├── smtp_config.dart          # Настройки SMTP
│   └── sms_providers.dart        # Конфигурация SMS-шлюзов
└── workers/
    ├── email_worker.dart         # Воркер для email
    └── sms_worker.dart           # Воркер для SMS

7 Подсистема чата (Messaging)
Чат является критически важным инструментом коммуникации между всеми участниками процесса (клиентами, тренерами, инструкторами, менеджерами).
7.1 Функциональные требования
7.1.1 	Типы чатов
Система должна поддерживать следующие типы бесед:
1. Личные сообщения (Peer-to-Peer):
o Между любыми двумя пользователями системы, у которых есть права на общение (например, клиент может писать своему тренеру, но не может писать другому клиенту, если это не разрешено настройками).
2. Групповые чаты (Broadcast / Group):
o Тренер → Его клиенты: Создается автоматически для каждого тренера с его клиентами.
o Инструктор → Его клиенты: Создается автоматически для каждого инструктора с его клиентами.
o Менеджер → Группа сотрудников/клиентов: Для объявлений.
o Возможность создания групповых чатов вручную (например, менеджером) с выбором участников.
3. Системные уведомления:
o Уведомления от системы (напоминания, изменения расписания)
o Broadcast сообщения от администрации

7.1.2 Базовый функционал
• Отправка сообщений:
o Текстовые сообщения.
o Поддержка вложений.
• История сообщений: Полная история переписки должна храниться и подгружаться при открытии чата (с пагинацией).
• Статусы сообщений:
o sent (отправлено), delivered (доставлено получателю), read (прочитано).
o В групповых чатах статус read должен отображаться в виде списка прочитавших (или количества).
• Индикаторы активности:
o Индикатор "онлайн" (зеленая точка) рядом с аватаром пользователя.
o Индикатор "печатает..." (is typing...) в реальном времени.
• Уведомления:
o Push-уведомления на устройство при новом сообщении, если пользователь не в активном чате.
o Звуковое оповещение (опционально, настраивается пользователем).
o Бейджи (цифры) на иконке чата в интерфейсе, указывающие на количество непрочитанных сообщений.
7.1.3 Управление чатами
• Список чатов: Интерфейс должен отображать список всех чатов пользователя, отсортированный по времени последнего сообщения.
o Для каждого чата в списке отображается: аватар/название, последнее сообщение (или вложение), время и бейдж непрочитанных.
• Поиск по чатам и сообщениям: Возможность быстрого поиска по названиям чатов и тексту сообщений.
• Архивация чатов: Возможность скрыть чат из основного списка без удаления истории.
7.1.4 Автоматическое создание чатов
• При назначении клиента тренеру → создается личный чат
• При создании группового занятия → создается групповой чат участников
• При найме нового сотрудника → добавляется в общие чаты филиала

7.2 Архитектура и техническая реализация
7.2.1 Технологический стек
• Backend: Dart сервер на Shelf/Dart Frog
• База данных: PostgreSQL 15+
• Real-time: WebSocket + Redis Pub/Sub
• Хранение файлов: Локальная файловая система
• Клиент: Flutter WebSocket client
7.2.2 Компоненты системы

// Структура серверной части чата
chat_server/
├── lib/
│   ├── websocket_server.dart    # WebSocket обработчик
│   ├── chat_service.dart        # Бизнес-логика чата
│   ├── message_repository.dart  # Работа с БД
│   └── redis_service.dart       # Pub/Sub для реального времени
├── config/
│   └── database.dart           # Конфигурация БД
└── bin/
    └── server.dart             # Точка входа

7.2.3 Таблицы чата
-- Таблица чатов
-- Таблица участников чата
-- Таблица сообщений
-- Таблица статусов сообщений (для отслеживания прочтения)

7.2.4 Алгоритмы и процессы
• Создание личного чата: Происходит автоматически при первой попытке отправить сообщение пользователю, если чата еще не существует.
• Доставка и прочтение:
1. Сообщение сохраняется в БД, ему присваивается статус sent.
2. Через Realtime канал оно мгновенно доставляется всем онлайн-участникам чата. В БД для них проставляется статус delivered.
3. Когда пользователь открывает чат, клиентское приложение отправляет команду на сервер о прочтении всех сообщений в этом чате. В БД проставляется статус read.
• Индикатор "печатает...": При начале ввода текста в поле сообщения клиент отправляет через Realtime событие typing_start в канал чата. При остановке или отправке сообщения — событие typing_stop.
7.3 Требования к интерфейсу (UI/UX)
• Экран списка чатов: Должен быть доступен с главного навигационного меню каждого дашборда.
• Экран чата:
o Шапка с названием чата и списком участников (для групповых).
o Область сообщений с группировкой по датам.
o Панель ввода сообщения с кнопкой отправки.
o На втором этапе: кнопка прикрепления файла.
• Контекстные меню: Должен быть реализован функционал "долгого нажатия" на сообщение для его копирования или пересылки (для администраторов/менеджеров).
7.4 Безопасность и контроль доступа
• Row Level Security (RLS): Должны быть настроены строгие политики RLS на все таблицы чатов. Пользователь может видеть и писать только в те чаты, участником которых он является.
• Валидация: Проверка прав пользователя на отправку сообщения в конкретный чат должна выполняться на стороне сервера перед сохранением сообщения.
• Модерация: На втором этапе рассмотреть возможность удаления сообщений для ролей Менеджер/Администратор.

8 Подсистема отчетности (Reporting & Analytics)
Подсистема отчетности предоставляет руководству и менеджерам инструмент для анализа эффективности фитнес-центра, сотрудников и бизнес-процессов на основе накопленных данных.
8.1 Общие принципы
• Доступ на основе ролей: Отчеты доступны только пользователям с ролями Администратор и Менеджер. Уровень детализации данных может различаться (например, менеджер видит данные только по своим клиентам/тренерам, а администратор — по всему центру).
• Интерактивность: Отчеты должны быть интерактивными: с возможностью фильтрации, сортировки и детализации (drill-down). Например, клик на цифру "Количество занятий" открывает список этих занятий.
• Визуализация: Данные должны представляться в виде сводных таблиц, графиков (столбчатые, линейные, круговые) и дашбордов с KPI.
• Экспорт: Все отчеты должны поддерживать экспорт данных в форматы PDF (для печати и презентаций) и XLSX/CSV (для дальнейшего анализа в Excel).
8.2 Виды отчетов
8.2.1 Отчетность по клиентам
8.2.1.1 Отчет «Динамика клиентской базы»
o Цель: Анализ притока и оттока клиентов.
o Параметры: Период (месяц, квартал, год).
o Метрики:
• Новые клиенты (зарегистрировались за период).
• Активные клиенты (посетили хотя бы 1 занятие за период).
• Ушедшие клиенты (не были на занятиях последние N дней).
• Общее количество клиентов на конец периода.
• График: Динамика изменения этих показателей over time.
8.2.1.2 Отчет «Посещаемость и прогресс клиентов»
o Цель: Оценка вовлеченности и эффективности тренировок.
o Параметры: Период, конкретный клиент (опционально), тренер (опционально).
o Метрики:
• Общее количество проведенных занятий.
• Процент посещаемости от запланированных занятий.
• Среднее количество занятий в неделю на одного клиента.
• Динамика изменения веса, обхватов тела.
• Динамика потребленных и затраченных калорий (дефицит/профицит).
• Достижение целей (количество клиентов, достигших целевого веса за период).
8.2.2 Отчетность по сотрудникам
8.2.2.1 Отчет «Загрузка и эффективность тренеров»
o Цель: Оценка продуктивности и загруженности тренерского состава.
o Параметры: Период, конкретный тренер (опционально).
o Метрики:
• Общее количество проведенных занятий.
• Общее количество рабочих часов (по табелю).
• Количество прикрепленных клиентов (на начало и конец периода).
• Средний доход с клиента (если интегрировано с финансовой системой. Это вынесено за рамки данной системы и будет интегрироваться via API).
• Рейтинг тренера на основе отзывов клиентов (если функционал реализован).
• График: Сравнительная диаграмма загрузки тренеров.
8.2.2.2 Отчет «Табель учета рабочего времени» (Расширенная версия)
o Цель: Финальное подведение итогов для payroll (расчета заработной платы).
o Параметры: Расчетный период (например, с 1 по последнее число месяца).
o Метрики: По каждому сотруднику:
• Отработанные часы (суммировано из занятий).
• Количество проведенных индивидуальных/групповых занятий.
• Простои/опоздания (если ведется учет).
• Экспорт: Обязательный вывод в XLSX для бухгалтерии.
8.2.3 Отчетность по занятиям и расписанию
8.2.3.1 Отчет «Статистика занятий»
o Цель: Анализ популярности направлений и загрузки зала.
o Параметры: Период, тип занятия (индивидуальное/групповое), зал (если несколько).
o Метрики:
• Распределение занятий по типам (индив./групп.).
• Распределение занятий по планам тренировок (похудение, масса и т.д.).
• Процент отмененных/перенесенных занятий.
• Среднее количество участников в групповых занятиях.
• График: Загрузка зала по времени суток и дням недели.
8.2.4 Отчетность по помещениям и оборудованию
• Отчет по загрузке залов
• Анализ использования оборудования
• Отчет по затратам на обслуживание
8.2.5 Финансовая отчетность по центру (если интегрировано с кассой/оплатами)
8.2.5.1 Отчет «Выручка и платежи»
o Цель: Контроль финансовых потоков.
o Параметры: Период.
o Метрики:
• Общая выручка за период.
• Выручка по типам услуг (абонементы, разовые занятия, персональные тренировки).
• Количество оформленных абонементов.
• Динамика выручки (сравнение с предыдущим периодом).
• График: Круговая диаграмма структуры выручки.
8.3 Техническая реализация
8.3.1 Архитектура
• Источник данных: Все отчеты строятся на основе основной базы данных PostgreSQL (таблицы users, lessons, track_calories, anthropometry_start/finish и др.).
• Генерация отчетов: Для сложных отчетов с агрегацией данных рекомендуется использовать представления (Views) или материализованные представления (Materialized Views) в PostgreSQL для оптимизации производительности.
• API: Бэкенд должен предоставлять API-эндпоинты для получения данных отчетов в формате JSON, которые затем визуализируются на фронтенде.
o Пример эндпоинта: GET /api/reports/client_dynamics?start_date=2023-01-01&end_date=2023-12-31
8.3.2 Интерфейс генератора отчетов
• Дашборд «Аналитика» в интерфейсе Администратора/Менеджера.
• Левая панель: Древовидный список всех доступных отчетов.
• Центральная часть:
1. Панель параметров: Выбор периода, фильтров (тренер, клиент, тип занятия).
2. Область визуализации: Здесь отображаются графики и таблицы.
3. Панель инструментов: Кнопки "Обновить", "Экспорт в PDF", "Экспорт в Excel".
8.4 Пример технического задания для одного отчета
Отчет: «Динамика клиентской базы за период»
• Эндпоинт API: GET /api/reports/client_dynamics
• Параметры запроса (Query Parameters):
o start_date (обязательный)
o end_date (обязательный)
• Ответ (Response Body):
json
{
  "period": {"start": "2023-01-01", "end": "2023-12-31"},
  "metrics": {
    "new_clients": 150,
    "active_clients": 400,
    "churned_clients": 45,
    "total_clients_end": 1200
  },
  "chart_data": [
    {"month": "2023-01", "new": 10, "active": 350, "churned": 5, "total": 1000},
    {"month": "2023-02", "new": 15, "active": 370, "churned": 8, "total": 1007},
    ...
  ]
}
• Логика расчета на бэкенде:
o new_clients: COUNT пользователей с ролью 'client', у которых created_at входит в период.
o active_clients: COUNT уникальных user_id из таблицы lessons, где start_fact_at входит в период и complete = 'completed'.
o churned_clients: COUNT клиентов, у которых последнее занятие (MAX(start_fact_at)) было раньше, чем end_date - 30 days (или другой порог "ухода").
o total_clients_end: COUNT пользователей с ролью 'client' на дату end_date.

9 Подсистема управления пользователями (User Management)
Подсистема управления пользователями является фундаментом всей системы, обеспечивая безопасную аутентификацию, гибкую авторизацию на основе ролей и централизованное управление учетными записями.
9.1 Модель данных и ролевая система
9.1.1 Сущность «Пользователь» (User)
Универсальная сущность, хранящая общие данные для всех участников системы.
• Базовые поля:
o id (BIGSERIAL, Primary Key)
o login (String, Unique) // Логин для входа (может совпадать с email/телефоном)
o password_hash (String) // Хеш пароля (алгоритм bcrypt)
o email (String, Unique, Nullable)
o phone (String, Unique, Nullable)
o last_name (String)
o first_name (String)
o middle_name (String, Nullable)
o gender (SMALLINT) //значение перечисления в коде
o date_of_birth (DATE) //День рождения
o photo_url (String, Nullable) // Ссылка на аватар в хранилище
o created_at (Timestamp)
o updated_at (Timestamp)
o archived_at (Timestamp)
o archived_by (BIGINT FK → users(id))
o created_by (BIGINT FK → users(id))
o updated_by (BIGINT FK → users(id))

• Настройки уведомлений (хранятся в таблице user_settings):
o send_notifications (Boolean, default: true) // Разрешить уведомления
o hour_notification (Integer) // За сколько часов уведомлять о занятии
o notification_email (Boolean) // Получать на email
o notification_push (Boolean) // Получать push-уведомления
9.1.2 Ролевая модель (Role-Based Access Control - RBAC)
Гибкая система, позволяющая назначать пользователю несколько ролей.
• Таблица roles:
o id (Primary Key)
o name (String, Unique: 'client', 'instructor', 'trainer', 'manager', 'admin') // Системное имя
o title (String) // Человекочитаемое название ('Клиент', 'Тренер')
o icon (String) // Иконка роли для UI
• Таблица user_roles (связь многие-ко-многим):
o user_id (Foreign Key -> users)
o role_id (Foreign Key -> roles)
o assigned_at (Timestamp)
• Иерархия и комбинации ролей:
o Пользователь может иметь несколько ролей.
o Пример: В небольшом клубе тренер может иметь роли trainer, manager и admin.
o Наличие роли определяется бизнес-логикой, а не техническими ограничениями.
9.1.3 Профили конкретных ролей (Profile Tables)
Дополнительные данные, специфичные для роли, хранятся в отдельных таблицах с связью One-to-One к основной таблице users.
• Таблица client_profiles (для клиентов):
o user_id (Primary Key, Foreign Key -> users)
o goal_training_id (Foreign Key -> goals_training)
o level_training_id (Foreign Key -> levels_training)
o track_calories (Boolean, default: true) // Включить учет калорий
o coeff_activity (Double, default: 1.2) // Коэффициент активности

• Таблица instructor_profiles (для инструкторов):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах
o is_duty (Boolean, default: false) // Дежурный (логика на основе employees_duty)
o can_replace_trainer (Boolean, default: false) // Может замещать тренера
o can_create_plan (Boolean, default: false) // Может создавать планы тренировок

• Таблица trainer_profiles (для тренеров):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах

• Таблица manager_profiles (для менеджеров):
o user_id (Primary Key, Foreign Key -> users)
o specialization (String, Nullable) // Специализация
o work_experience (Integer, Nullable) // Стаж в годах
o is_duty (Boolean, default: false) // Дежурный (логика на основе employees_duty)

9.1.4 Требования к ролям в пользовательских интерфейсах

1. Пользователи с ролями "Инструктор", "Тренер", "Менеджер" могут иметь несколько ролей, кроме роли "Клиент".
2. Если роль одна, созданная при создании пользователя, то она считается основной. В дашбордах перечисленных пользователей она не отображается.
3. Если ролей несколько, то в дашборде выводится список ролей с подзаголовком: "Роли". Добавлять или удалять роли из списка может только администратор. Основную роль удалить нельзя.
4. Если у пользователя несколько ролей, то при входе предлагать выбор роли в попап-окне. Такой же функционал при входе в дашборд из списка пользователей в дашборде администратора.
5.  Пользователи с ролью "Клиент" могут иметь только одну роль при создании.

9.2 Функциональные требования
9.2.1 Жизненный цикл учетной записи
• Создание пользователя:
o Сценарий А (Администратором): Через интерфейс "Создание пользователя" с ручным назначением ролей.
o Сценарий Б (Самостоятельная регистрация): Через процесс онбординга (пригласительная ссылка).
• Активация/Деактивация: Возможность временно отключить учетную запись без удаления данных (is_active = false).
• Удаление: Строго логическое удаление. Запись помечается как удаленная (is_deleted = true), данные сохраняются для аудита.
9.2.2 Аутентификация и безопасность
• Вход в систему: По паре login (email/телефон) и password.
• Политика паролей:
o Минимальная длина: 8 символов.
o Обязательные категории: заглавные и строчные буквы, цифры, специальный символ.
o Запрет на использование простых паролей (проверка against словаря).
• Защита от брутфорса: Блокировка учетной записи после 5 неудачных попыток входа за 15 минут.
• Сброс пароля: Стандартный flow через email с одноразовой ссылкой.
• Смена пароля: Обязательна при первом входе, если пароль был установлен администратором.
9.2.3 Управление пользователями (CRUD)
• Просмотр списка пользователей:
o Интерфейс: Единый дашборд с возможностью фильтрации по ролям, активности, ФИО.
o Отображение: Аватар, ФИО, основные роли, контакты, статус активности.
• Создание/Редактирование пользователя:
o Универсальная форма: Основные поля (ФИО, контакты, логин).
o Динамические блоки: В зависимости от выбранных ролей появляются дополнительные поля (например, блок "Данные клиента" при назначении роли client).
o Назначение ролей: Выбор из списка с чекбоксами.
• Управление доступом: Только пользователи с ролями admin и manager имеют полный доступ к CRUD. Тренер может просматривать и редактировать только своих клиентов.
9.3 Техническая реализация
9.3.1 Безопасность (Row Level Security - RLS)
• Для всех таблиц (users, client_profiles, etc.) должны быть настроены политики RLS.
• Пример политики для users:
o Администратор (role_admin) видит всех пользователей.
o Менеджер (role_manager) видит пользователей, которые являются его клиентами/тренерами/инструкторами (через таблицы связей manager_client, manager_trainer, manager_instructor).
o Тренер (role_trainer) видит только себя и своих клиентов/инструкторов.
o Инструктор (role_instructor) видит только себя и своих.
o Клиент (role_client) видит только свою учетную запись.
9.3.2 Процессы и бизнес-логика
• Создание клиента из лида: При нажатии "Создать клиента" в карточке лида система:
1. Создает запись в users на основе данных из onboarding_client.
2. Назначает пользователю роль client.
3. Создает запись в client_profiles.
4. Устанавливает связь trainer_client с тренером-менеджером.
• Проверка уникальности: При создании/редактировании обязательна проверка на уникальность login, email, phone.

9.4 Требования к списочным формам, карточкам, дашбордам
• Все ListView должны быть пагинированы.
• В карточке или дашборде, в панели инструментов должна быть кнопка "Инфо", по клику которой в popup-окне выводится диагностическая информация: имя таблицы сущности, id записи таблицы. Так же выводятся поля: created_at, updated_at, created_by, updated_by. Данная кнопка доступна всем, кроме клиентов.
9.5 Требования к личной информации в дашбордах
В каждом типе дашборда пользователей должен быть экран "Профиль" с основными данными из таблицы users:
• photo (URL). //Фото.
• login (string). //Логин.
• lastName (string). //Фамилия.
• firstName (string). //Имя.
• middleName (string). //Отчество.
• fullName (string). //Полное ФИО, расчетное.
• shortName (string). //Краткое ФИО, расчетное.
• gender (string). //Пол.
• date_of_birth (DateTime). //День рождения.
• age (int). //Возраст. Расчетное.
• phone (string). //Телефон.
• email (string). //E-mail.
• sendNotification (bool). //Посылать уведомления. Поле есть у всех, кроме админа.
• hourNotification (duration). //Время уведомления до занятий (в часах).  Поле есть у всех, кроме админа.
• List<Role> roles. //Список ролей, если больше одной. Поле есть у всех, кроме клиента.
В случае дашборда клиента, отображаются дополнительные поля:
• trackCalories (bool) //Учет калорий.
• double coeffActivity = //Минимальный коэффициент активности.

Экран должен отображаться после нажатия на кнопку "Профиль" в меню дашборда.

23


