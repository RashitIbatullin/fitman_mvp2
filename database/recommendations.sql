-- recommendations.sql
-- Таблицы для подсистемы рекомендаций

-- 1. Каталог "Типы телосложения" для алгоритма определения соматотипа
CREATE TABLE IF NOT EXISTS types_body_build (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(20) NOT NULL, -- 'Эктоморф', 'Мезоморф', 'Эндоморф'
    description VARCHAR(200),
    gender VARCHAR(20) NOT NULL, -- 'M', 'Ж', 'ALL'
    wrist_min REAL,
    wrist_max REAL,
    ankle_min REAL,
    ankle_max REAL,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

-- Начальные данные для types_body_build (из ТЗ)
INSERT INTO types_body_build (name, gender, wrist_min, wrist_max, ankle_min, ankle_max) VALUES
('Эктоморф', 'M', NULL, 17.5, NULL, 21.5),
('Мезоморф', 'M', 17.5, 19.5, 21.5, 25.5),
('Эндоморф', 'M', 19.5, NULL, 25.5, NULL),
('Эктоморф', 'Ж', NULL, 15.5, NULL, 21.5),
('Мезоморф', 'Ж', 15.5, 17.5, 21.5, 25.5),
('Эндоморф', 'Ж', 17.5, NULL, 25.5, NULL);

-- 2. Таблица готовых рекомендаций (ядро системы)
CREATE TABLE IF NOT EXISTS training_recommendations (
    id BIGSERIAL PRIMARY KEY,
    body_type VARCHAR(50) NOT NULL, -- 'Яблоко', 'Груша', 'Песочные часы', 'Прямоугольник', 'Перевернутый треугольник', 'Не определен'
    goal_training_id BIGINT REFERENCES goals_training(id),
    level_training_id BIGINT REFERENCES levels_training(id),
    recommendation_text_trainer TEXT NOT NULL, -- Для тренера (более детально)
    recommendation_text_client TEXT NOT NULL, -- Для клиента (простыми словами)
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

-- Полное заполнение таблицы training_recommendations для всех типов фигур
INSERT INTO training_recommendations 
(body_type, goal_training_id, level_training_id, recommendation_text_trainer, recommendation_text_client) 
VALUES 
-- ТИП ФИГУРЫ: Яблоко (Андроидный)
('Яблоко', 1, 1, 
'**Цель: Похудение (Начальный уровень)**
- **Тренировки:** Акцент на снижение висцерального жира. Рекомендуется сочетание кардио и силовых.
  - **Кардио:** 3-4 раза в неделю по 30-40 минут умеренной интенсивности (быстрая ходьба, эллипс).
  - **Силовые:** 2-3 раза в неделю, full-body тренировки с базовыми упражнениями (приседания, жимы, тяги) для ускорения метаболизма. Избегать прямых скручиваний на пресс с весом, чтобы не увеличивать талию.
- **Питание:** Умеренный дефицит калорий (300-500 ккал). Ограничить простые углеводы и насыщенные жиры. Повысить потребление белка и клетчатки для контроля аппетита.',
'**Ваша цель - похудение.**
- **Тренировки:** Сосредоточьтесь на сжигании жира в области живота. 3-4 раза в неделю делайте кардио (быстрая ходьба, эллипс), и 2-3 раза - силовые на все тело.
- **Питание:** Ешьте чуть меньше обычного, избегайте сладкого и жирного. Больше белка (курица, рыба, творог) и овощей.'),

('Яблоко', 1, 2,
'**Цель: Похудение (Средний уровень)**
- **Тренировки:** Увеличение интенсивности.
  - **Кардио:** Добавить 2-3 сессии HIIT (высокоинтенсивный интервальный тренинг) в неделю по 15-20 минут.
  - **Силовые:** 3 раза в неделю, можно переходить на сплит "верх/низ". Акцент на ноги и спину для создания мышечного корсета и улучшения пропорций.
- **Питание:** Продолжать следовать диете с дефицитом калорий. Можно применять методы вроде углеводного чередования для стимуляции метаболизма.',
'**Ваша цель - похудение.**
- **Тренировки:** Пора добавить интенсивности! Попробуйте интервальные тренировки (чередование высокой и низкой скорости) 2-3 раза в неделю. Силовые разделите на "верх" и "низ" тела.
- **Питание:** Продолжайте питаться с небольшим дефицитом. Можно пробовать дни с большим и меньшим количеством углеводов.'),

('Яблоко', 1, 3,
'**Цель: Похудение (Продвинутый уровень)**
- **Тренировки:** Максимальное жиросжигание.
  - **Кардио:** 3-4 сессии HIIT. Можно использовать протоколы Табата.
  - **Силовые:** 3-4 раза в неделю. Тяжелые базовые упражнения для максимального метаболического отклика. Активная работа над осанкой.
- **Питание:** Строгий контроль калорийности и БЖУ. Возможно применение более продвинутых диетических стратегий (KETO, LCHF) под наблюдением специалиста.',
'**Ваша цель - похудение.**
- **Тренировки:** Используйте продвинутые интервальные тренировки. В силовых сосредоточьтесь на тяжелых базовых упражнениях (приседания, становая тяга).
- **Питание:** Строго следите за питанием. Можно изучить более сложные диеты, но лучше с тренером.'),

-- Цель: Набор массы (2) для "Яблока" - специфическая задача
('Яблоко', 2, 1,
'**Цель: Набор массы (Начальный уровень)**
- **Тренировки:** Осторожный набор с минимальным увеличением талии.
  - **Силовые:** 3-4 раза в неделю, акцент на плечи, спину и ноги для создания V-образного силуэта.
  - **Кардио:** 2-3 раза в неделю по 20-30 минут низкой интенсивности для здоровья сердца.
- **Питание:** Небольшой профицит калорий (200-300 ккал). Основу рациона должны составлять сложные углеводы и белок.',
'**Ваша цель - набор массы.**
- **Тренировки:** 3-4 силовые тренировки в неделю, делая упор на плечи, спину и ноги. Это поможет создать атлетичные пропорции.
- **Питание:** Ешьте немного больше обычного, налегая на каши, макароны из твердых сортов и белковые продукты.'),

-- ТИП ФИГУРЫ: Груша (Гиноидный)
('Груша', 1, 1,
'**Цель: Похудение (Начальный уровень)**
- **Тренировки:** Акцент на балансировку пропорций (укрепление верха, уменьшение низа).
  - **Силовые:** 3 раза в неделю. 60% упражнений на верхнюю часть тела (плечи, спина, грудь). На ноги - многоповторные упражнения (15-20) с небольшим весом.
  - **Кардио:** 3-4 раза в неделю, можно с акцентом на верх тела (гребной тренажер).
- **Питание:** Умеренный дефицит калорий. Контроль потребления жиров.',
'**Ваahа цель - похудение и гармонизация фигуры.**
- **Тренировки:** Больше внимания верху тела (плечи, спина), чтобы визуально уравновесить фигуру. Ноги тренируйте с небольшим весом, но на большое количество повторений.
- **Питание:** Ешьте чуть меньше, контролируйте жирную пищу.'),

('Груша', 1, 2,
'**Цель: Похудение (Средний уровень)**
- **Тренировки:** Увеличение интенсивности на верх тела.
  - **Силовые:** Сплит "верх/низ". В день верха - увеличение рабочих весов. В день низа - круговые и многоповторные сеты.
  - **Кардио:** Добавить HIIT 2 раза в неделю.
- **Питание:** Продолжать следить за дефицитом калорий. Убедитесь, что потребляете достаточно белка для роста мышц верха.',
'**Ваша цель - похудение и гармонизация фигуры.**
- **Тренировки:** Разделите тренировки на "верх" и "низ". В день верха старайтесь работать с большим весом, в день низа - в интенсивном режиме "без остановки".
- **Питание:** Продолжайте питаться с небольшим дефицитом, ешьте достаточно белка.'),

-- ... (продолжение для всех типов, целей и уровней)
-- Для краткости примера, я заполню еще несколько, но в реальном файле нужно заполнить все комбинации.

('Песочные часы', 1, 1,
'**Цель: Похудение (Начальный уровень)**
- **Тренировки:** Задача - сохранить пропорции.
  - **Силовые:** 3 раза в неделю, full-body тренировки сбалансированно на все группы мышц.
  - **Кардио:** 3-4 раза в неделю по 30 минут умеренной интенсивности.
- **Питание:** Умеренный дефицит калорий. Сбалансированный рацион по БЖУ.',
'**Ваша цель - похудение с сохранением форм.**
- **Тренировки:** Тренируйте все тело равномерно, чтобы сохранить ваши прекрасные пропорции.
- **Питание:** Просто ешьте немного меньше обычной порции, сохраняя баланс в еде.'),

('Не определен', 1, 1,
'**Общие рекомендации для похудения (Начальный уровень)**
- **Тренировки:** Сбалансированный подход.
  - **Кардио:** 3 раза в неделю по 30 минут.
  - **Силовые:** 2-3 раза в неделю на все тело.
- **Питание:** Начните с уменьшения порций на 15-20% и исключите самые вредные продукты (фастфуд, сладкие напитки).',
'**Начните свой путь к похудению!**
- **Тренировки:** Сочетайте кардио (3 раза в неделю) и силовые (2-3 раза в неделю).
- **Питание:** Ешьте чуть меньше и откажитесь от фастфуда и газировки.');


-- 3. Таблица для хранения сгенерированных AI рекомендаций (опционально, на будущее)
CREATE TABLE IF NOT EXISTS ai_recommendation_cache (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    profile_snapshot JSONB NOT NULL, -- "Портрет" клиента на момент запроса
    recommendation_text TEXT NOT NULL, -- Ответ от AI
    ai_model VARCHAR(50), -- 'deepseek', 'yandexgpt' и т.д.
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, created_at) -- Можно хранить историю, убрав UNIQUE
);

-- 4. Таблицы биоимпеданса
CREATE TABLE IF NOT EXISTS bioimpedance_start (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    date_time TIMESTAMPTZ NOT NULL,
    fat_percentage REAL,
    muscle_mass REAL,
    water_percentage REAL,
    visceral_fat INTEGER,
    bmc REAL,
    bmi REAL,
    metabolism INTEGER,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS bioimpedance_finish (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    date_time TIMESTAMPTZ NOT NULL,
    fat_percentage REAL,
    muscle_mass REAL,
    water_percentage REAL,
    visceral_fat INTEGER,
    bmc REAL,
    bmi REAL,
    metabolism INTEGER,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_bioimpedance_start_user_id ON bioimpedance_start(user_id);
CREATE INDEX IF NOT EXISTS idx_bioimpedance_finish_user_id ON bioimpedance_finish(user_id);
