-- recommendations.sql
-- Таблицы для подсистемы рекомендаций

-- 1. Каталог "Типы телосложения" для алгоритма определения соматотипа
CREATE TABLE IF NOT EXISTS types_body_build (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(20) NOT NULL, -- 'Эктоморф', 'Мезоморф', 'Эндоморф'
    description VARCHAR(200),
    gender VARCHAR(20) NOT NULL, -- 'M', 'Ж', 'ALL'
    wrist_min REAL,
    wrist_max REAL,
    ankle_min REAL,
    ankle_max REAL,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

-- Начальные данные для types_body_build (из ТЗ)
INSERT INTO types_body_build (name, gender, wrist_min, wrist_max, ankle_min, ankle_max) VALUES
('Эктоморф', 'M', NULL, 17.5, NULL, 21.5),
('Мезоморф', 'M', 17.5, 19.5, 21.5, 25.5),
('Эндоморф', 'M', 19.5, NULL, 25.5, NULL),
('Эктоморф', 'Ж', NULL, 15.5, NULL, 21.5),
('Мезоморф', 'Ж', 15.5, 17.5, 21.5, 25.5),
('Эндоморф', 'Ж', 17.5, NULL, 25.5, NULL);

-- 2. Таблица готовых рекомендаций (ядро системы)
CREATE TABLE IF NOT EXISTS training_recommendations (
    id BIGSERIAL PRIMARY KEY,
    body_type VARCHAR(50) NOT NULL, -- 'Яблоко', 'Груша', 'Песочные часы', 'Прямоугольник', 'Перевернутый треугольник', 'Не определен'
    goal_training_id BIGINT REFERENCES goals_training(id),
    level_training_id BIGINT REFERENCES levels_training(id),
    recommendation_text_trainer TEXT NOT NULL, -- Для тренера (более детально)
    recommendation_text_client TEXT NOT NULL, -- Для клиента (простыми словами)
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

-- Полное заполнение таблицы training_recommendations для всех типов фигур
INSERT INTO training_recommendations 
(body_type, goal_training_id, level_training_id, recommendation_text_trainer, recommendation_text_client) 
VALUES 
-- ТИП ФИГУРЫ: Яблоко (жир сосредоточен в области талии)
-- Цель: Похудение (1)
('Яблоко', 1, 1, 
 'Акцент на снижение висцерального жира. HIIT 3 раза в неделю, силовые тренировки всего тела. Кардио умеренной интенсивности 150 мин/неделю. Исключить скручивания на пресс. Баланс: 40% кардио, 40% силовых, 20% мобильность.',
 'Для снижения веса в области талии: делайте интервальные тренировки (чередуйте быстрые и медленные упражнения), занимайтесь силовыми тренировками на все группы мышц. Избегайте упражнений на пресс с большой нагрузкой.'),

('Яблоко', 1, 2,
 'Увеличить HIIT до 4 раз, добавить круговые тренировки. Силовые: акцент на ноги и спину для создания мышечного корсета. Кардио 200 мин/неделю. Добавить дыхательные упражнения для снижения кортизола.',
 'Повысьте интенсивность интервальных тренировок. Добавьте круговые тренировки для сжигания калорий. Укрепляйте мышцы ног и спины - это создаст баланс фигуры.'),

('Яблоко', 1, 3,
 'Специализированные HIIT-протоколы (табата). Силовые: тяжелые базовые упражнения для ускорения метаболизма. Кардио 250 мин/неделю. Работа над осанкой для визуального уменьшения талии.',
 'Используйте продвинутые интервальные тренировки (например, табата). Сосредоточьтесь на базовых силовых упражнениях (приседания, тяги). Работайте над осанкой - это визуально уменьшит талию.'),

-- Цель: Набор массы (2)  
('Яблоко', 2, 1,
 'Осторожный набор с контролем талии. Силовые 4 раза в неделю с акцентом на плечи и ноги для создания V-образного силуэта. Кардио 120 мин/неделю умеренно. Диета с профицитом 200-300 ккал.',
 'Для набора массы с акцентом на плечи и ноги: силовые тренировки 4 раза в неделю. Контролируйте объем талии. Кардио сохраняйте для здоровья сердца.'),

('Яблоко', 2, 2,
 'Сплит-тренировки: верх/низ. Акцент на развитие плеч и спины для баланса. Контроль объема талии еженедельно. Кардио 100 мин/неделю низкой интенсивности.',
 'Разделите тренировки на верх и низ тела. Уделяйте особое внимание плечам и спине. Регулярно измеряйте талию для контроля.'),

('Яблоко', 2, 3,
 'Специализация на дельтовидных и трапециевидных мышцах. Тяжелые базовые упражнения с контролем техники. Кардио 90 мин/неделю. Периодизация для минимизации жироотложения.',
 'Сфокусируйтесь на развитии плеч. Используйте тяжелые базовые упражнения с идеальной техникой. Кардио - минимально необходимое.'),

-- ТИП ФИГУРЫ: Груша (широкие бедра, узкие плечи)
-- Цель: Похудение (1)
('Груша', 1, 1,
 'Баланс пропорций: акцент на верх тела при похудении. Силовые: 60% верх, 40% низ. Кардио равномерное. Исключить приседания с большим весом. Добавить упражнения на плечи и спину.',
 'Для гармоничной фигуры: укрепляйте плечи и спину. Упражнения на ноги делайте с умеренным весом. Кардио - равномерно на все тело.'),

('Груша', 1, 2,
 'Сплит: день верха, день низа. Увеличить объем тренировок верха тела. Кардио с акцентом на интервалы. Упражнения на ягодицы без увеличения объема.',
 'Разделите тренировки: один день - верх тела, другой - низ. Больше внимания плечам и спине. Кардио - интервальное.'),

('Груша', 1, 3,
 'Специализация на создании V-образного верха. Тяжелые жимы и тяги. Низ тела - функциональные тренировки без гипертрофии. Кардио HIIT 3 раза в неделю.',
 'Создавайте V-образный верх: тяжелые жимы и тяги. Тренируйте ноги функционально, без большого веса. HIIT-кардио 3 раза в неделю.'),

-- Цель: Набор массы (2)
('Груша', 2, 1,
 'Сбалансированный набор: пропорциональное развитие. Силовые: 50/50 верх/низ. Кардио минимальное. Акцент на технику для предотвращения дисбалансов.',
 'Набирайте массу равномерно. Тренируйте и верх, и низ тела одинаково интенсивно. Следите за техникой.'),

('Груша', 2, 2,
 'Приоритет верха тела: 60% верх, 40% низ. Тяжелые базовые упражнения на плечи и спину. Контролировать развитие бедер. Кардио 60 мин/неделю.',
 'Уделяйте больше внимания верху тела (60%). Тяжелые упражнения на плечи и спину. Контролируйте развитие бедер.'),

('Груша', 2, 3,
 'Специализация на построение широких плеч и спины. Изолированные упражнения на дельты. Ноги тренировать с умеренным объемом. Периодизация.',
 'Специализация на плечи и спину. Много изолированных упражнений на плечи. Ноги - умеренно. Планируйте циклы нагрузки.'),

-- ТИП ФИГУРЫ: Песочные часы (плечи = бедра, узкая талия)
-- Цель: Похудение (1)
('Песочные часы', 1, 1,
 'Поддержание пропорций при похудении. Сбалансированные тренировки всего тела. Кардио умеренное. Сохранение мышечной массы верха и низа.',
 'Для похудения сохраняйте гармоничные пропорции: тренируйте все тело равномерно. Сохраняйте мышечную массу.'),

('Песочные часы', 1, 2,
 'Тренировки для рельефа без потери пропорций. Сплит-тренировки с акцентом на сохранение мышечной массы. HIIT для жиросжигания.',
 'Для рельефа: раздельные тренировки на группы мышц. Сохраняйте мышечную массу верха и низа. HIIT для сжигания жира.'),

('Песочные часы', 1, 3,
 'Специализированные тренировки для конкурсной подготовки. Изолированная работа над слабыми группами. Сушка с сохранением пропорций.',
 'Для соревновательного рельефа: изолированно прорабатывайте отстающие мышцы. Сохраняйте баланс фигуры при сушке.'),

-- Цель: Набор массы (2)
('Песочные часы', 2, 1,
 'Пропорциональный набор массы. Комплексные тренировки всего тела. Умеренный профицит калорий. Сохранение талии.',
 'Набирайте массу пропорционально: тренируйте все тело комплексно. Сохраняйте узкую талию.'),

('Песочные часы', 2, 2,
 'Раздельные тренировки с акцентом на развитие отстающих групп. Балансировка пропорций. Контроль объема талии.',
 'Тренируйте группы мышц раздельно. Развивайте отстающие мышцы для идеального балансa. Контролируйте талию.'),

('Песочные часы', 2, 3,
 'Специализация для бодибилдинга. Изолированная проработка каждой мышечной группы. Максимизация пропорций при наборе.',
 'Для максимальных пропорций: изолированно прорабатывайте каждую мышцу. Стремитесь к идеальному балансу фигуры.'),

-- ТИП ФИГУРЫ: Прямоугольник (плечи ≈ бедра, минимальная талия)
-- Цель: Похудение (1)
('Прямоугольник', 1, 1,
 'Создание иллюзии талии. Тренировки с акцентом на плечи и ягодицы. Кардио для общего жиросжигания. Упражнения на косые мышцы умеренно.',
 'Для создания талии: укрепляйте плечи и ягодицы. Это создаст контраст с талией. Кардио - для общего похудения.'),

('Прямоугольник', 1, 2,
 'Развитие верха и низа для создания X-силуэта. Тяжелые упражнения на плечи и ягодицы. Кардио HIIT. Избегать расширения талии.',
 'Создавайте X-силуэт: развивайте плечи и ягодицы. HIIT-кардио. Избегайте упражнений, расширяющих талию.'),

('Прямоугольник', 1, 3,
 'Специализированные тренировки для создания выраженных плеч и ягодиц. Изолированные упражнения. Сушка с акцентом на сохранение мышц верха/низа.',
 'Для выраженного X-силуэта: специализируйтесь на плечах и ягодицах. Сохраняйте эти мышцы при сушке.'),

-- Цель: Набор массы (2)
('Прямоугольник', 2, 1,
 'Развитие плеч и ягодиц для создания формы. Базовые упражнения. Контроль объема талии. Умеренный набор.',
 'Для создания формы: развивайте плечи и ягодицы. Базовые упражнения. Контролируйте талию.'),

('Прямоугольник', 2, 2,
 'Приоритет на развитие дельт и ягодичных. Тяжелые изолированные упражнения. Балансировка пропорций.',
 'Приоритет - плечи и ягодицы. Тяжелые изолированные упражнения. Балансируйте пропорции.'),

('Прямоугольник', 2, 3,
 'Специализация на конкурсную форму. Максимальное развитие верха и низа при сохранении талии. Периодизация.',
 'Для соревнований: максимально развивайте плечи и ягодицы. Сохраняйте талию. Планируйте циклы.'),

-- ТИП ФИГУРЫ: Перевернутый треугольник (широкие плечи, узкие бедра)
-- Цель: Похудение (1)
('Перевернутый треугольник', 1, 1,
 'Балансировка фигуры: акцент на низ тела. Силовые: 40% верх, 60% низ. Кардио равномерное. Уменьшение объема плеч.',
 'Для баланса: больше внимания ногам и ягодицам (60%). Меньше - верху тела. Кардио - равномерное.'),

('Перевернутый треугольник', 1, 2,
 'Сплит с акцентом на низ. Развитие ягодиц и бедер. Верх тела - поддерживающие тренировки. Кардио с акцентом на низ.',
 'Тренируйте низ тела интенсивнее. Верх - поддерживающе. Кардио с акцентом на нижнюю часть.'),

('Перевернутый треугольник', 1, 3,
 'Специализация на развитие низа тела. Тяжелые приседания и выпады. Верх - изоляция без увеличения объема. Сушка с сохранением низа.',
 'Специализация на ноги и ягодицы. Тяжелые базовые упражнения. Верх - без увеличения объема.'),

-- Цель: Набор массы (2)
('Перевернутый треугольник', 2, 1,
 'Сбалансированный набор с акцентом на низ. Развитие бедер и ягодиц. Верх - умеренно. Сохранение пропорций.',
 'Набирайте массу с акцентом на низ тела. Развивайте бедра и ягодицы. Верх - умеренно.'),

('Перевернутый треугольник', 2, 2,
 'Приоритет на развитие низа: 70% низ, 30% верх. Тяжелые упражнения на ноги. Верх - для симметрии.',
 '70% тренировок - низ тела. Тяжелые упражнения на ноги. Верх - для симметрии.'),

('Перевернутый треугольник', 2, 3,
 'Специализация на конкурсный низ тела. Максимальное развитие ягодиц и бедер. Верх - минимально для баланса.',
 'Максимально развивайте низ тела для соревнований. Верх - минимально для баланса.'),

-- Дополнительно: рекомендации для случаев без определения типа фигуры
('Не определен', 1, 1,
 'Общие рекомендации для похудения. Сбалансированные тренировки: 50% кардио, 50% силовых. Постепенное увеличение нагрузки.',
 'Для похудения: сочетайте кардио и силовые тренировки. Постепенно увеличивайте нагрузку.'),

('Не определен', 2, 1,
 'Общие рекомендации для набора массы. Силовые тренировки 4 раза в неделю. Профицит калорий 300-500. Адекватный отдых.',
 'Для набора массы: силовые тренировки 4 раза в неделю. Питайтесь с небольшим избытком калорий. Отдыхайте достаточно.');

-- 3. Таблица для хранения сгенерированных AI рекомендаций (опционально, на будущее)
CREATE TABLE IF NOT EXISTS ai_recommendation_cache (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    profile_snapshot JSONB NOT NULL, -- "Портрет" клиента на момент запроса
    recommendation_text TEXT NOT NULL, -- Ответ от AI
    ai_model VARCHAR(50), -- 'deepseek', 'yandexgpt' и т.д.
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, created_at) -- Можно хранить историю, убрав UNIQUE
);

-- 4. Таблицы биоимпеданса
CREATE TABLE IF NOT EXISTS bioimpedance_start (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    date_time TIMESTAMPTZ NOT NULL,
    fat_percentage REAL,
    muscle_mass REAL,
    water_percentage REAL,
    visceral_fat INTEGER,
    bmc REAL,
    bmi REAL,
    metabolism INTEGER,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS bioimpedance_finish (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    date_time TIMESTAMPTZ NOT NULL,
    fat_percentage REAL,
    muscle_mass REAL,
    water_percentage REAL,
    visceral_fat INTEGER,
    bmc REAL,
    bmi REAL,
    metabolism INTEGER,
    company_id BIGINT DEFAULT -1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by BIGINT REFERENCES users(id),
    updated_by BIGINT REFERENCES users(id),
    archived_at TIMESTAMPTZ,
    archived_by BIGINT REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_bioimpedance_start_user_id ON bioimpedance_start(user_id);
CREATE INDEX IF NOT EXISTS idx_bioimpedance_finish_user_id ON bioimpedance_finish(user_id);
